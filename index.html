<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grass Invoice PDF Parser â€” Steel-only + DB + Descartes Export</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:1800px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{padding:28px 32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .header h1{font-size:22px;font-weight:800;margin-bottom:6px}
    .header p{opacity:.9}

    .db-banner{padding:8px 28px 0 28px;font-size:13px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .db-status{font-weight:600}
    .db-status.loading{color:#92400e}
    .db-status.loaded{color:#065f46}
    .db-status.offline{color:#4b5563}
    .db-info{color:#6b7280;font-size:12px}
    .db-btn{padding:4px 10px;border-radius:999px;border:0;background:#e5e7eb;font-size:11px;cursor:pointer}

    .upload{padding:28px}
    .drop{border:2px dashed #c7d2fe;border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:.2s}
    .drop:hover{background:#f8fafc}
    #fileInput{display:none}
    .loading{padding:28px;display:none;text-align:center}
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #6366f1;border-radius:50%;width:44px;height:44px;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bar{display:flex;gap:12px;align-items:center;padding:16px 20px;background:#f8fafc;border-top:1px solid #eef2ff;border-bottom:1px solid #eef2ff;flex-wrap:wrap}
    .bar select,.bar input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;min-width:220px}
    .bar button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    .bar .ghost{background:#eef2ff;color:#111}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px 20px;background:#fff}
    .stat{border:1px solid #eef2ff;border-radius:12px;padding:12px}
    .stat .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin-bottom:6px}
    .stat .val{font-size:18px;font-weight:800}

    .table{border-top:1px solid #eef2ff}
    .thead{background:#111;color:#fff;overflow:auto}
    .tbody{max-height:62vh;overflow:auto}
    .thead table,.tbody table{width:100%;table-layout:fixed;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-align:left}
    td input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:8px}
    .readonly{background:#f3f4f6}
    .actions{white-space:nowrap}
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
    .btn.del{background:#fee2e2}
    .btn.add{background:#dbeafe}
    .col-pos{width:64px}.col-part{width:260px}.col-qty{width:100px}.col-unit{width:72px}
    .col-price{width:120px}.col-total{width:130px}.col-weight{width:120px}.col-coo{width:80px}.col-act{width:160px}

    .alert{display:none;margin:12px 20px;padding:10px 12px;border-radius:10px;border:1px solid}
    .alert.ok{display:block;background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .alert.err{display:block;background:#fef2f2;border-color:#fecaca;color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Grass Invoice PDF Parser (Steel-only)</h1>
      <p>Only steel sublines are kept. Base line total = original invoice total âˆ’ sum of steel sublines.</p>
    </div>

    <!-- DB banner -->
    <div class="db-banner">
      <span id="dbStatus" class="db-status loading">DB: not loaded</span>
      <span id="dbInfo" class="db-info">Will try to load updated_grass_db.xlsx from GitHub or local fileâ€¦</span>
      <button id="retryDbBtn" class="db-btn">Retry DB</button>
      <button id="offlineDbBtn" class="db-btn">Work offline</button>
    </div>

    <div class="upload" id="upload">
      <div class="drop" id="drop">
        <h3>ðŸ“¤ Click or Drag & Drop a PDF</h3>
        <p style="margin-top:6px;color:#6b7280">Optimized for Grass consolidated invoice format. Multiple invoices supported.</p>
        <input id="fileInput" type="file" accept="application/pdf,.pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Parsing PDF textâ€¦</strong></div>
    </div>

    <div class="alert" id="alert"></div>

    <div class="bar" id="bar" style="display:none">
      <select id="invoiceSel"><option value="">Select an invoiceâ€¦</option></select>
      <input id="supplierInp" placeholder="Supplier (edit)" />
      <input id="dateInp" placeholder="Invoice Date MM/DD/YYYY" />
      <input id="totalInp" type="number" step="0.01" placeholder="Invoice Total (USD)" />
      <button id="exportBtn">Export to Descartes Template</button>
      <button id="newBtn" class="ghost">New Upload</button>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="label">Invoice</div><div class="val" id="stInv">-</div></div>
      <div class="stat"><div class="label">Items</div><div class="val" id="stItems">0</div></div>
      <div class="stat"><div class="label">Invoice Total</div><div class="val" id="stTotal">$0.00</div></div>
      <div class="stat"><div class="label">Sum of Lines</div><div class="val" id="stSum">$0.00</div></div>
      <div class="stat"><div class="label">Difference</div><div class="val" id="stDiff">$0.00</div></div>
    </div>

    <div class="table" id="table" style="display:none">
      <div class="thead" id="thead">
        <table><thead><tr>
          <th class="col-pos">Pos</th>
          <th class="col-part">Part Number / Description</th>
          <th class="col-qty">Quantity</th>
          <th class="col-unit">Unit</th>
          <th class="col-price">Unit Price</th>
          <th class="col-total">Line Total</th>
          <th class="col-weight">Net Weight (kg)</th>
          <th class="col-coo">COO</th>
          <th class="col-act">Actions</th>
        </tr></thead></table>
      </div>
      <div class="tbody" id="tbody">
        <table><tbody id="rows"></tbody></table>
      </div>
    </div>
  </div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const UI = {
    upload: $('#upload'), drop: $('#drop'), file: $('#fileInput'), loading: $('#loading'),
    alert: $('#alert'), bar: $('#bar'), invSel: $('#invoiceSel'),
    supplierInp: $('#supplierInp'), dateInp: $('#dateInp'), totalInp: $('#totalInp'),
    stats: $('#stats'), stInv: $('#stInv'), stItems: $('#stItems'),
    stTotal: $('#stTotal'), stSum: $('#stSum'), stDiff: $('#stDiff'),
    table: $('#table'), thead: $('#thead'), tbody: $('#tbody'),
    rows: $('#rows'), exportBtn: $('#exportBtn'), newBtn: $('#newBtn')
  };

  let ALL = [], ORDER = [], CURRENT = '', filename = '';
  let grassDb = []; // hydrated from updated_grass_db.xlsx when available

  // ======= DB loader for updated_grass_db.xlsx =======
  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo:  'all_in_one_manki',     // adjust here if needed
    branch:'main',
    filePath: 'updated_grass_db.xlsx'
  };

  const dbStatusEl    = document.getElementById('dbStatus');
  const dbInfoEl      = document.getElementById('dbInfo');
  const retryDbBtn    = document.getElementById('retryDbBtn');
  const offlineDbBtn  = document.getElementById('offlineDbBtn');

  function setDbBanner(state,msg,info){
    if(!dbStatusEl) return;
    let cls = 'db-status';
    if(state==='loading') cls+=' loading';
    else if(state==='loaded') cls+=' loaded';
    else if(state==='offline') cls+=' offline';
    dbStatusEl.className = cls;
    dbStatusEl.textContent = msg;
    if(dbInfoEl && info!=null) dbInfoEl.textContent = info;
  }

  function abortableFetch(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    return fetch(url,{signal:ctrl.signal}).finally(()=>clearTimeout(t));
  }

  async function fetchAndReadWorkbook(url, useAbort){
    const res = useAbort ? await abortableFetch(url,8000) : await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf,{type:'array'});
  }

  async function hydrateDbFromWorkbook(workbook){
    const sheetName =
      workbook.SheetNames.find(n => n.toLowerCase().includes('grass')) ||
      workbook.SheetNames[0];
    grassDb = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {defval:''});
  }

  function enterOfflineMode(reason){
    grassDb = grassDb || [];
    setDbBanner('offline','DB: offline', reason || 'Proceeding without DB enrichment.');
  }

  async function loadDatabaseFromGitHub(){
    const {owner,repo,branch,filePath} = GITHUB_CONFIG;
    const remoteUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
    const localUrl  = './updated_grass_db.xlsx';

    setDbBanner('loading','DB: loadingâ€¦','Trying GitHub (8s timeout)â€¦');

    try{
      const wb = await fetchAndReadWorkbook(remoteUrl,true);
      await hydrateDbFromWorkbook(wb);
      setDbBanner('loaded','DB: loaded from GitHub', new Date().toLocaleString());
      return;
    }catch(err1){
      console.warn('[DB] GitHub load failed', err1?.message || err1);
      setDbBanner('loading','DB: retrying from localâ€¦','Looking for ./updated_grass_db.xlsx');
      try{
        const wb2 = await fetchAndReadWorkbook(localUrl,false);
        await hydrateDbFromWorkbook(wb2);
        setDbBanner('loaded','DB: loaded from local', new Date().toLocaleString());
        return;
      }catch(err2){
        console.warn('[DB] Local db load failed', err2?.message || err2);
        enterOfflineMode('DB could not be loaded from GitHub or local file.');
      }
    }
  }

  retryDbBtn?.addEventListener('click', ()=> loadDatabaseFromGitHub().catch(()=>{}));
  offlineDbBtn?.addEventListener('click', ()=> enterOfflineMode('Offline mode selected by user.'));

  window.addEventListener('DOMContentLoaded', ()=>{
    loadDatabaseFromGitHub().catch(()=>{});
  });

  // ======= Utility helpers =======
  function showAlert(msg, ok=true){
    UI.alert.className = 'alert ' + (ok?'ok':'err');
    UI.alert.textContent = msg;
    UI.alert.style.display='block';
    setTimeout(()=> UI.alert.style.display='none', 3200);
  }

  function parseNum(s){
    if(s==null) return NaN;
    const t=String(s).trim();
    if(!t) return NaN;
    if(/\d+[.,]\d{3}[.,]\d{2}$/.test(t)){
      const last = t.lastIndexOf('.')>t.lastIndexOf(',')?'.':',';
      const intPart=t.slice(0,t.lastIndexOf(last)).replace(/[.,\s]/g,'');
      const dec=t.slice(t.lastIndexOf(last)+1);
      return parseFloat(intPart+'.'+dec);
    }
    if(/,\d{2}$/.test(t) && !/\.\d{2}$/.test(t))
      return parseFloat(t.replace(/\./g,'').replace(',','.'));
    return parseFloat(t.replace(/,/g,''));
  }

  const fmt2  = n => (isFinite(+n)? (+n).toFixed(2):'');
  const toUS  = d => {
    const m=String(d||'').match(/(\d{2})\.(\d{2})\.(\d{4})/);
    return m ? `${m[2]}/${m[1]}/${m[3]}` : (d||'');
  };
  const sumLines = list => list.reduce((a,r)=> a + (parseNum(r.line_total)||0), 0);

  // ======= File handling =======
  UI.drop.addEventListener('click', ()=> UI.file.click());
  UI.file.addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(f) handleFile(f);
  });
  UI.drop.addEventListener('dragover', e=>{
    e.preventDefault();
    UI.drop.style.background='#f1f5ff';
  });
  UI.drop.addEventListener('dragleave', ()=> UI.drop.style.background='');
  UI.drop.addEventListener('drop', e=>{
    e.preventDefault();
    UI.drop.style.background='';
    const f=e.dataTransfer.files?.[0];
    if(f) handleFile(f);
  });
  UI.newBtn.addEventListener('click', ()=> location.reload());

  async function handleFile(file){
    if(!/\.pdf$/i.test(file.name)){
      showAlert('Please upload a PDF file', false);
      return;
    }
    filename = file.name.replace(/\.pdf$/i,'');
    UI.upload.style.display='none';
    UI.loading.style.display='block';
    try{
      const buf = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let text = '';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const tc = await page.getTextContent({includeMarkedContent:true});
          text += (tc.items||[]).map(it=> it?.str || '').join(' ') + "\n";
        }catch(e){
          console.warn('page read failed', i, e);
        }
      }
      if(!text.trim()){
        showAlert('PDF has no extractable text (maybe scanned). Try OCR.', false);
        UI.upload.style.display='block';
        return;
      }
      parseGrass(text);
      ORDER.forEach(id => applySteelAdjustments(id));
      if(ALL.length){
        buildUI();
        showAlert(
          `Found ${new Set(ALL.map(x=>x.invoice_number)).size} invoice(s), ${ALL.length} row(s)`,
          true
        );
      } else {
        showAlert('No invoice rows were parsed. Try another file or adjust patterns.', false);
        UI.upload.style.display='block';
      }
    }catch(err){
      console.error(err);
      showAlert('Error: '+(err.message||String(err)), false);
      UI.upload.style.display='block';
    } finally{
      UI.loading.style.display='none';
    }
  }

  // ======= Core Grass parsing (global steel pairing by net weight) =======
  function parseGrass(text){
    ALL.length = 0;
    ORDER.length = 0;
    const big = String(text||'');

    // Invoice meta (assume single consolidated invoice number)
    const invm = [...big.matchAll(/Invoice\s+(\d{5,})/gi)];
    const invNum = invm.length? invm[0][1] : 'UNKNOWN';
    if(!ORDER.includes(invNum)) ORDER.push(invNum);

    let invDate = '';
    const dm = big.match(/Date:\s*(\d{2}\.\d{2}\.\d{4})/);
    if(dm) invDate = toUS(dm[1]);

    let supplier = 'GRASS GmbH';
    if(/\bGRASS\s+GmbH\s+(Ã–sterreich|Osterreich)\b/i.test(big))
      supplier = 'GRASS GmbH Ã–sterreich';

    let invTotal = '';
    const tm = big.match(/Total\s+Amount\s+([\d.,]+)\s+USD/i);
    if(tm) invTotal = String(parseNum(tm[1])||'');

    // 1) Find all base items
    const itemRegex =
      /\b(F[0-9]{9,})\s+(\d+[\d.,]*)\s+(PCS|PC|SET|PAIRS?)\s+([\d.,]+)\s*\/\s*(\d+)\s+([\d.,]+)\s+USD/gi;
    const items = [];
    let m;
    while((m = itemRegex.exec(big)) !== null){
      items.push({
        idx: m.index,
        part: m[1],
        qty: parseNum(m[2]),
        unit: m[3].toUpperCase(),
        unitPricePer: parseNum(m[4]),
        perDivisor: parseNum(m[5]),
        lineTotal: parseNum(m[6])
      });
    }

    // 2) Precompute base meta (net weight, COO) for each item
    const meta = items.map(()=>({
      baseNetkg: NaN,
      netkgStr: '',
      coo: ''
    }));

    items.forEach((it, i)=>{
      const start = it.idx;
      const end   = (i < items.length-1 ? items[i+1].idx : big.length);
      const slab  = big.slice(start, end);

      const wM = slab.match(/Net\s*weight\s*in\s*kg:\s*([\d.,]+)/i);
      if(wM){
        const base = parseNum(wM[1]);
        if(isFinite(base)){
          meta[i].baseNetkg = base;
          meta[i].netkgStr  = fmt2(base);
        }
      }
      const cooM = slab.match(/Country\s+of\s+Origin:\s*([A-Z]{2})/i);
      if(cooM){
        meta[i].coo = cooM[1].toUpperCase();
      }
    });

    // 3) Collect ALL steel blocks globally in the text
    const steelBlocks = [];
    const steelBlockRegex =
      /Net\s*weight\s*in\s*kg\s*in\s*steel\s*:\s*([\d.,]+)[\s\S]*?Steel\s*value\s*:\s*([\d.,]+)/gi;
    let sbMatch;
    while((sbMatch = steelBlockRegex.exec(big)) !== null){
      steelBlocks.push({
        idx: sbMatch.index,
        steelKG: parseNum(sbMatch[1]),
        steelVal: parseNum(sbMatch[2])
      });
    }

    // 4) Assign steel blocks to items by net weight + text order
    const steelForItem = items.map(()=>({ steelKG: NaN, steelVal: NaN }));
    const REL_THRESHOLD = 0.6; // up to 60% relative difference allowed

    steelBlocks.forEach(block=>{
      const {steelKG, steelVal, idx: steelIdx} = block;
      if(!isFinite(steelKG) && !isFinite(steelVal)) return;

      let bestItem = -1;
      let bestDiffRel = Infinity;
      let bestDist = Infinity;

      items.forEach((it, i)=>{
        const baseNet = meta[i].baseNetkg;
        if(!isFinite(baseNet)) return;
        if(steelIdx <= it.idx) return; // steel block must appear after the item

        const diffRel = Math.abs(steelKG - baseNet) / Math.max(Math.abs(steelKG), Math.abs(baseNet), 1);
        if(diffRel > REL_THRESHOLD) return;

        const dist = steelIdx - it.idx;
        if(diffRel < bestDiffRel - 1e-9 ||
           (Math.abs(diffRel - bestDiffRel) < 1e-9 && dist < bestDist)){
          bestDiffRel = diffRel;
          bestDist = dist;
          bestItem = i;
        }
      });

      if(bestItem >= 0){
        const t = steelForItem[bestItem];
        if(isFinite(steelKG)){
          t.steelKG = isFinite(t.steelKG) ? (t.steelKG + steelKG) : steelKG;
        }
        if(isFinite(steelVal)){
          t.steelVal = isFinite(t.steelVal) ? (t.steelVal + steelVal) : steelVal;
        }
      }
    });

    // 5) If no items, still push a placeholder
    if(!items.length){
      ALL.push({
        invoice_number:invNum, invoice_date:invDate, supplier, invoice_total:invTotal,
        position:'', part_number:'', quantity:'', unit:'', unit_price:'',
        line_total:'', net_weight:'', country_of_origin:''
      });
      return;
    }

    // 6) Final pass: build ALL rows (base + steel S-lines)
    items.forEach((it, i)=>{
      const pos = (i+1).toString();
      const baseNetkg = meta[i].baseNetkg;
      const netkgStr  = meta[i].netkgStr;
      const coo       = meta[i].coo;

      const unitPrice =
        (isFinite(it.unitPricePer) && isFinite(it.perDivisor) && it.perDivisor>0)
          ? (it.unitPricePer / it.perDivisor)
          : '';

      const origLineTotal = isFinite(it.lineTotal) ? fmt2(it.lineTotal) : '';

      // Base line: keep original invoice total; steel adjustments happen later
      ALL.push({
        invoice_number: invNum,
        invoice_date:  invDate,
        supplier,
        invoice_total: invTotal,
        position: pos,
        part_number: it.part,
        quantity: isFinite(it.qty)? fmt2(it.qty) : '',
        unit: it.unit,
        unit_price: isFinite(unitPrice) ? fmt2(unitPrice) : '',
        line_total: origLineTotal,
        _origLineTotal: origLineTotal,
        net_weight: netkgStr,
        country_of_origin: coo
      });

      // Steel S-line if we have a steel value
      const sInfo = steelForItem[i];
      const sVal  = sInfo.steelVal;
      const sKG   = sInfo.steelKG;
      if(isFinite(sVal) && sVal>0){
        ALL.push({
          invoice_number: invNum,
          invoice_date:  invDate,
          supplier,
          invoice_total: invTotal,
          position: pos + 'S',
          part_number: 'Steel - ' + it.part,
          quantity: isFinite(sKG)? fmt2(sKG):'',
          unit:'KG',
          unit_price:'',
          line_total: fmt2(sVal),
          net_weight:'',
          country_of_origin: coo,
          origin: 'auto_steel'
        });
      }
    });
  }

  // ======= UI building & editing =======
  function buildUI(){
    UI.bar.style.display='flex';
    const header = UI.thead, body = UI.tbody;
    let sync=false;
    body.addEventListener('scroll',()=>{
      if(sync) return;
      sync=true;
      header.scrollLeft = body.scrollLeft;
      sync=false;
    });

    UI.invSel.innerHTML = '<option value="">Select an invoiceâ€¦</option>';
    const metaInv = {};
    ALL.forEach(r=>{
      if(!metaInv[r.invoice_number]) metaInv[r.invoice_number] = {
        date:r.invoice_date, supplier:r.supplier, total:r.invoice_total, count:0
      };
      metaInv[r.invoice_number].count++;
    });
    ORDER.forEach(id=>{
      const m = metaInv[id]||{date:'',supplier:'',total:'',count:0};
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent =
        `Invoice ${id} â€” ${m.count} items â€” ${m.date} â€” ${m.supplier} â€” $${Number(m.total||0).toFixed(2)}`;
      UI.invSel.appendChild(opt);
    });

    UI.invSel.onchange = ()=>{
      CURRENT = UI.invSel.value;
      if(CURRENT) renderInvoice(CURRENT);
    };
    UI.exportBtn.onclick = exportToDescartes;

    CURRENT = ORDER[0];
    UI.invSel.value = CURRENT;
    renderInvoice(CURRENT);

    UI.invSel.tabIndex = 1;
    UI.supplierInp.tabIndex = 2;
    UI.dateInp.tabIndex = 3;
    UI.totalInp.tabIndex = 4;
  }

  function sortedRowsForCurrent(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn;
      return (A[2]||'').localeCompare(B[2]||'');
    });
    return rows;
  }

  function renderInvoice(id){
    const rows = sortedRowsForCurrent();
    const meta = rows[0]||{};

    UI.supplierInp.value = meta.supplier||'';
    UI.dateInp.value     = meta.invoice_date||'';
    UI.totalInp.value    = meta.invoice_total||'';

    UI.stInv.textContent   = id;
    UI.stItems.textContent = String(rows.length);
    UI.stTotal.textContent = '$'+Number(meta.invoice_total||0).toFixed(2);

    UI.rows.innerHTML = '';
    rows.forEach((r, idx)=>{ UI.rows.appendChild(renderRow(r, idx)); });

    UI.table.style.display='block';
    UI.stats.style.display='grid';
    recomputeStats();

    UI.supplierInp.onchange = e=> updateHdr('supplier', e.target.value);
    UI.dateInp.onchange     = e=> updateHdr('invoice_date', e.target.value);
    UI.totalInp.onchange    = e=> { updateHdr('invoice_total', e.target.value); recomputeStats(); };

    rebuildTabOrder();
  }

  function renderRow(row, idx){
    const tr = document.createElement('tr');
    function cell(val, key, ro=false){
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.value = val==null? '' : String(val);
      if(ro){
        inp.className='readonly';
        inp.readOnly=true;
      }
      inp.onchange = ()=> updateCell(idx, key, inp.value);
      inp.onkeydown = ev=>{
        if(ev.key==='Enter' || ev.key==='Tab'){
          ev.preventDefault();
          focusNext(inp, ev.shiftKey?-1:1);
        }
      };
      td.appendChild(inp);
      return td;
    }
    const actions = document.createElement('td');
    actions.className='actions';
    const add = document.createElement('button');
    add.className='btn add';
    add.textContent='âž• Below';
    add.onclick=()=> addBelow(idx);
    const del = document.createElement('button');
    del.className='btn del';
    del.textContent='ðŸ—‘ï¸';
    del.onclick=()=> removeRow(idx);
    actions.appendChild(add);
    actions.appendChild(del);

    tr.appendChild(cell(row.position,'position'));
    tr.appendChild(cell(row.part_number,'part_number'));
    tr.appendChild(cell(row.quantity,'quantity'));
    tr.appendChild(cell(row.unit,'unit'));
    tr.appendChild(cell(row.unit_price,'unit_price'));
    tr.appendChild(cell(row.line_total,'line_total'));
    tr.appendChild(cell(row.net_weight,'net_weight'));
    tr.appendChild(cell(row.country_of_origin,'country_of_origin'));
    tr.appendChild(actions);
    return tr;
  }

  function rebuildTabOrder(){
    let ti = 10;
    $$('#rows input').forEach(inp=>{ inp.tabIndex = ti++; });
  }

  function focusNext(current, dir){
    const inputs = [
      UI.invSel, UI.supplierInp, UI.dateInp, UI.totalInp,
      ...$$('#rows input')
    ].filter(Boolean);
    const idx = inputs.indexOf(current);
    const nextIdx = Math.max(0, Math.min(inputs.length-1, idx + (dir||1)));
    const target = inputs[nextIdx];
    if(target){
      target.focus();
      if(target.select) target.select();
    }
  }

  function updateCell(viewIdx, key, val){
    const rows = sortedRowsForCurrent();
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){
      ALL[idx][key]=val;
      applySteelAdjustments(CURRENT);
      renderInvoice(CURRENT);
    }
  }

  function addBelow(viewIdx){
    const rows = sortedRowsForCurrent();
    const base = rows[viewIdx];
    const baseNum = String(base.position||'').replace(/[A-Z]$/,'');
    const insert = {
      invoice_number: CURRENT,
      invoice_date: base.invoice_date,
      supplier: base.supplier,
      invoice_total: base.invoice_total,
      position: baseNum + 'S',
      part_number:'',
      quantity:'',
      unit:'',
      unit_price:'',
      line_total:'',
      net_weight:'',
      country_of_origin: base.country_of_origin,
      origin: 'manual_steel'
    };
    const idx = ALL.indexOf(base);
    ALL.splice(idx+1, 0, insert);
    applySteelAdjustments(CURRENT);
    renderInvoice(CURRENT);
  }

  function removeRow(viewIdx){
    const rows = sortedRowsForCurrent();
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){
      ALL.splice(idx,1);
      applySteelAdjustments(CURRENT);
      renderInvoice(CURRENT);
    }
  }

  function updateHdr(field, val){
    ALL.forEach(r=>{
      if(r.invoice_number===CURRENT){
        r[field]=val;
      }
    });
  }

  function recomputeStats(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT);
    const invTotal = parseNum(rows[0]?.invoice_total);
    const sum = sumLines(rows);
    UI.stTotal.textContent = '$'+(isFinite(invTotal)?invTotal.toFixed(2):'0.00');
    UI.stSum.textContent   = '$'+sum.toFixed(2);
    const diff = (isFinite(invTotal)?invTotal:0) - sum;
    UI.stDiff.textContent  = '$'+diff.toFixed(2);
  }

  // === Steel adjustment: base line total = original âˆ’ sum(steel sublines) ===
  function applySteelAdjustments(invId){
    if(!invId) return;
    const rows = ALL.filter(r=>r.invoice_number===invId);
    const groups = {};
    rows.forEach(r=>{
      const m = String(r.position||'').match(/^(\d+)([A-Z]?)$/);
      if(!m) return;
      const baseNum = m[1];
      const suffix = (m[2]||'').toUpperCase();
      if(!groups[baseNum]) groups[baseNum] = { base:null, steels:[] };
      if(!suffix){
        groups[baseNum].base = r;
      } else if(suffix === 'S'){
        groups[baseNum].steels.push(r);
      }
    });

    Object.values(groups).forEach(group=>{
      const base = group.base;
      if(!base) return;
      const orig = parseNum(base._origLineTotal || base.line_total);
      if(!isFinite(orig)) return;
      let steelSum = 0;
      group.steels.forEach(s=>{
        const v = parseNum(s.line_total);
        if(isFinite(v)) steelSum += v;
      });
      const newTotal = Math.max(0, orig - steelSum);
      base.line_total = fmt2(newTotal);
    });
  }

  // ======= Descartes export =======
  function exportToDescartes(){
    if(!ALL.length){
      showAlert('No data to export', false);
      return;
    }

    const items = ALL.slice().sort((a,b)=>{
      const ai = String(a.invoice_number||''); const bi = String(b.invoice_number||'');
      if (ai !== bi) return ai.localeCompare(bi);
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn;
      return (A[2]||'').localeCompare(B[2]||'');
    });

    const roundWeight = (val) => {
      const num = parseNum(val);
      if (isNaN(num)) return '';
      if (num < 1 && num > 0) return 1;
      if (num <= 0) return '';
      return Math.round(num);
    };

    const currentUiSupplierByInvoice = {};
    try{
      const uiSupplier = UI.supplierInp?.value || '';
      const uiInvoice  = CURRENT || '';
      if(uiInvoice){ currentUiSupplierByInvoice[uiInvoice] = uiSupplier; }
    }catch(_){}
    items.forEach(rec=>{
      const inv = rec.invoice_number;
      if(!currentUiSupplierByInvoice[inv]) currentUiSupplierByInvoice[inv] = rec.supplier || '';
    });

    const exportRows = [];
    items.forEach(item => {
      const supplierForInvoice = (currentUiSupplierByInvoice[item.invoice_number] || item.supplier || '');
      const buyerPartNum = item.part_number || '';
      const supplierPartNum = item.part_number || '';

      const row = {
        'InvoiceNumber': item.invoice_number || '',
        'InvoiceDate': item.invoice_date || '',
        'InvoiceTotal': item.invoice_total || '',
        'SupplierMID': '',
        'SupplierName': supplierForInvoice,
        'BuyerPartNumber': buyerPartNum,
        'SupplierPartNumber': supplierPartNum,
        'Quantity': item.quantity || '',
        'UnitOfMeasure': item.unit || '',
        'Description': '',
        'UnitPrice': item.unit_price || '',
        'ItemTotal': item.line_total || '',
        'CurrencyCode': 'USD',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin || '',
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': roundWeight(item.net_weight),
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': ''
      };

      exportRows.push(row);
    });

    const headers = [
      'InvoiceNumber','InvoiceDate','InvoiceTotal','SupplierMID','SupplierName',
      'BuyerPartNumber','SupplierPartNumber','Quantity','UnitOfMeasure','Description',
      'UnitPrice','ItemTotal','CurrencyCode','ExchangeRate','CountryOfOrigin',
      'CountryOfExport','DateOfExport','PortOfLading','RelatedParty','PO_Number',
      'PO_Date','GrossWeight','GrossWeightUnit','NetWeight','TariffNumber',
      'TariffDescription','Quantity1','UnitOfMeasure1','Quantity2','UnitOfMeasure2',
      'Quantity3','UnitOfMeasure3','PrimarySPI','SecondarySPI','DeliverTo','SoldTo',
      'SellerMID','ShipperMID','EntryDate','ArrivalDate','Carrier','Vessel','Voyage',
      'PortOfEntry','PortOfUnloading','LocationCode','TotalCharges','BillOfLadingNumber',
      'Container','SecondaryTariffNumber','SecondaryTariffdescription','Secondary Quantity1',
      'Secondaryunitofmeasure1','secondaryquantity2','secondaryunitofmeasure2',
      'secondaryquantity3','secondaryunitofmeasure3','secondaryvalue','FTZStatus',
      'FTZPrivilegedDate\u00a0','ThirdTariffNumber','ThirdTariffDescription',
      'ThirdTariffQuantity1','ThirdTariffUnitofMeasure1','ThirdTariffQuantity2',
      'ThirdTariffUnitofMeasure2','ThirdTariffQuantity3','ThirdTariffUnitofMeasure3',
      'Third Value','4TariffNumber','4TariffDescription','4TariffQuantity1',
      '4TariffUnitofMeasure1','4TariffQuantity2','4TariffUnitofMeasure2',
      '4TariffQuantity3','4TariffUnitofMeasure3'
    ];

    const aoa = [headers];
    exportRows.forEach(r=>{
      aoa.push(headers.map(h => (r[h] != null ? r[h] : '')));
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, 'DescartesUpload');

    const out  = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {
      type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href    = url;
    a.download = (filename? filename + '_' : '') + 'descartes_ci_upload.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
