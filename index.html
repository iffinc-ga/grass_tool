<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grass Invoice PDF Parser â€” Complete Export</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:1800px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{padding:28px 32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .header h1{font-size:22px;font-weight:800;margin-bottom:6px}
    .header p{opacity:.9}

    .db-banner{padding:8px 28px 0 28px;font-size:13px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .db-status{font-weight:600}
    .db-status.loading{color:#92400e}
    .db-status.loaded{color:#065f46}
    .db-status.offline{color:#4b5563}
    .db-info{color:#6b7280;font-size:12px}
    .db-btn{padding:4px 10px;border-radius:999px;border:0;background:#e5e7eb;font-size:11px;cursor:pointer}

    .upload{padding:28px}
    .drop{border:2px dashed #c7d2fe;border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:.2s}
    .drop:hover{background:#f8fafc}
    #fileInput{display:none}
    .loading{padding:28px;display:none;text-align:center}
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #6366f1;border-radius:50%;width:44px;height:44px;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bar{display:flex;gap:12px;align-items:center;padding:16px 20px;background:#f8fafc;border-top:1px solid #eef2ff;border-bottom:1px solid #eef2ff;flex-wrap:wrap}
    .bar select,.bar input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;min-width:220px}
    .bar button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    .bar .ghost{background:#eef2ff;color:#111}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px 20px;background:#fff}
    .stat{border:1px solid #eef2ff;border-radius:12px;padding:12px}
    .stat .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin-bottom:6px}
    .stat .val{font-size:18px;font-weight:800}

    .table{border-top:1px solid #eef2ff}
    .thead{background:#111;color:#fff;overflow:auto}
    .tbody{max-height:62vh;overflow:auto}
    .thead table,.tbody table{width:100%;table-layout:fixed;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-align:left}
    td input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:8px}
    .readonly{background:#f3f4f6}
    .actions{white-space:nowrap}
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
    .btn.del{background:#fee2e2}
    .btn.add{background:#dbeafe}
    .col-pos{width:64px}.col-part{width:260px}.col-qty{width:100px}.col-unit{width:72px}
    .col-price{width:120px}.col-total{width:130px}.col-weight{width:120px}.col-coo{width:80px}.col-act{width:160px}

    .alert{display:none;margin:12px 20px;padding:10px 12px;border-radius:10px;border:1px solid}
    .alert.ok{display:block;background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .alert.err{display:block;background:#fef2f2;border-color:#fecaca;color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Grass Invoice PDF Parser (Complete Export)</h1>
      <p>Steel-only sublines with full Descartes template export including tariff lookups and supplier MID matching.</p>
    </div>

    <!-- DB banner -->
    <div class="db-banner">
      <span id="dbStatus" class="db-status loading">DB: not loaded</span>
      <span id="dbInfo" class="db-info">Will try to load updated_grass_db.xlsx from GitHub or local fileâ€¦</span>
      <button id="retryDbBtn" class="db-btn">Retry DB</button>
      <button id="offlineDbBtn" class="db-btn">Work offline</button>
    </div>

    <div class="upload" id="upload">
      <div class="drop" id="drop">
        <h3>ðŸ“¤ Click or Drag & Drop a PDF</h3>
        <p style="margin-top:6px;color:#6b7280">Optimized for Grass consolidated invoice format. Multiple invoices supported.</p>
        <input id="fileInput" type="file" accept="application/pdf,.pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Parsing PDF textâ€¦</strong></div>
    </div>

    <div class="alert" id="alert"></div>

    <div class="bar" id="bar" style="display:none">
      <select id="invoiceSel"><option value="">Select an invoiceâ€¦</option></select>
      <input id="supplierInp" placeholder="Supplier (edit)" />
      <input id="dateInp" placeholder="Invoice Date MM/DD/YYYY" />
      <input id="totalInp" type="number" step="0.01" placeholder="Invoice Total (USD)" />
      <button id="exportBtn">Export</button>
      <button id="undoBtn" class="ghost">Undo last change</button>
      <button id="newBtn" class="ghost">New Upload</button>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="label">Invoice</div><div class="val" id="stInv">-</div></div>
      <div class="stat"><div class="label">Items</div><div class="val" id="stItems">0</div></div>
      <div class="stat"><div class="label">Invoice Total</div><div class="val" id="stTotal">$0.00</div></div>
      <div class="stat"><div class="label">Sum of Lines</div><div class="val" id="stSum">$0.00</div></div>
      <div class="stat"><div class="label">Difference</div><div class="val" id="stDiff">$0.00</div></div>
    </div>

    <div class="table" id="table" style="display:none">
      <div class="thead" id="thead">
        <table><thead><tr>
          <th class="col-pos">Pos</th>
          <th class="col-part">Part Number / Description</th>
          <th class="col-qty">Quantity</th>
          <th class="col-unit">Unit</th>
          <th class="col-price">Unit Price</th>
          <th class="col-total">Line Total</th>
          <th class="col-weight">Net Weight (kg)</th>
          <th class="col-coo">COO</th>
          <th class="col-act">Actions</th>
        </tr></thead></table>
      </div>
      <div class="tbody" id="tbody">
        <table><tbody id="rows"></tbody></table>
      </div>
    </div>
  </div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const UI = {
    upload: $('#upload'), drop: $('#drop'), file: $('#fileInput'), loading: $('#loading'),
    alert: $('#alert'), bar: $('#bar'), invSel: $('#invoiceSel'),
    supplierInp: $('#supplierInp'), dateInp: $('#dateInp'), totalInp: $('#totalInp'),
    stats: $('#stats'), stInv: $('#stInv'), stItems: $('#stItems'),
    stTotal: $('#stTotal'), stSum: $('#stSum'), stDiff: $('#stDiff'),
    table: $('#table'), thead: $('#thead'), tbody: $('#tbody'),
    rows: $('#rows'), exportBtn: $('#exportBtn'), newBtn: $('#newBtn'),
    undoBtn: $('#undoBtn')
  };

  let ALL = [], ORDER = [], CURRENT = '', filename = '';
  let grassDb = []; // populated from GRASS_DB sheet
  let htsCodesDb = []; // populated from hts_codes_with_uom sheet
  let steelAlumDb = []; // populated from Sheet1
  let supplierMidDb = []; // populated from MID sheet
  let supplierMidIndex = []; // built from supplierMidDb
  let undoStack = [];

  // ======= DB loader for updated_grass_db.xlsx =======
  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo:  'all_in_one_manki',   // adjust if needed
    branch:'main',
    filePath: 'updated_grass_db.xlsx'
  };

  const dbStatusEl    = document.getElementById('dbStatus');
  const dbInfoEl      = document.getElementById('dbInfo');
  const retryDbBtn    = document.getElementById('retryDbBtn');
  const offlineDbBtn  = document.getElementById('offlineDbBtn');

  function setDbBanner(state,msg,info){
    if(!dbStatusEl) return;
    let cls = 'db-status';
    if(state==='loading') cls+=' loading';
    else if(state==='loaded') cls+=' loaded';
    else if(state==='offline') cls+=' offline';
    dbStatusEl.className = cls;
    dbStatusEl.textContent = msg;
    if(dbInfoEl && info!=null) dbInfoEl.textContent = info;
  }

  function abortableFetch(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    return fetch(url,{signal:ctrl.signal}).finally(()=>clearTimeout(t));
  }

  async function fetchAndReadWorkbook(url, useAbort){
    const res = useAbort ? await abortableFetch(url,8000) : await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf,{type:'array'});
  }

  async function loadDatabaseFromGitHub(){
    const remoteUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.filePath}`;
    const localUrl  = './'+GITHUB_CONFIG.filePath;

    setDbBanner('loading','Loading database...','Trying GitHub (8s timeout)â€¦');
    try{
      const wb = await fetchAndReadWorkbook(remoteUrl, true);
      await hydrateDbsFromWorkbook(wb);
      setDbBanner('loaded', 'Database loaded âœ“', `Loaded from GitHub at ${new Date().toLocaleString()}`);
      return;
    }catch(err1){
      console.warn('[DB] GitHub load failed:', err1?.message || err1);
      setDbBanner('loading','Retrying from local fileâ€¦','Looking for ./updated_grass_db.xlsx');
      try{
        const wb2 = await fetchAndReadWorkbook(localUrl, false);
        await hydrateDbsFromWorkbook(wb2);
        setDbBanner('loaded','Database loaded âœ“ (local fallback)', `Loaded from local file at ${new Date().toLocaleString()}`);
        return;
      }catch(err2){
        console.warn('[DB] Local fallback failed:', err2?.message || err2);
        enterOfflineMode(`DB load failed. Working offline. You can still parse/edit and export (limited enrichment).`);
      }
    }
  }

  async function hydrateDbsFromWorkbook(workbook){
    // Load GRASS_DB sheet
    if(workbook.SheetNames.includes('GRASS_DB')){
      grassDb = XLSX.utils.sheet_to_json(workbook.Sheets['GRASS_DB']);
      console.log(`[DB] Loaded GRASS_DB: ${grassDb.length} rows`);
    } else {
      console.warn('[DB] GRASS_DB sheet not found');
      grassDb = [];
    }

    // Load hts_codes_with_uom sheet
    if(workbook.SheetNames.includes('hts_codes_with_uom')){
      htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets['hts_codes_with_uom']);
      console.log(`[DB] Loaded hts_codes_with_uom: ${htsCodesDb.length} rows`);
    } else {
      console.warn('[DB] hts_codes_with_uom sheet not found');
      htsCodesDb = [];
    }

    // Load Sheet1 (steel/aluminum mappings)
    if(workbook.SheetNames.includes('Sheet1')){
      steelAlumDb = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1']);
      console.log(`[DB] Loaded Sheet1 (steel/alum): ${steelAlumDb.length} rows`);
    } else {
      console.warn('[DB] Sheet1 not found');
      steelAlumDb = [];
    }

    // Load MID sheet
    if(workbook.SheetNames.includes('MID')){
      supplierMidDb = XLSX.utils.sheet_to_json(workbook.Sheets['MID'], {defval:''});
      buildSupplierMidIndex();
      console.log(`[DB] Loaded MID: ${supplierMidDb.length} rows`);
    } else {
      console.warn('[DB] MID sheet not found');
      supplierMidDb = [];
      supplierMidIndex = [];
    }
  }

  function enterOfflineMode(reason){
    grassDb = grassDb || [];
    htsCodesDb = htsCodesDb || [];
    steelAlumDb = steelAlumDb || [];
    supplierMidDb = supplierMidDb || [];
    supplierMidIndex = supplierMidIndex || [];
    setDbBanner('offline', 'Offline mode (DB skipped)', reason || 'You can continue without the DB.');
  }

  retryDbBtn.addEventListener('click', ()=> loadDatabaseFromGitHub());
  offlineDbBtn.addEventListener('click', ()=> enterOfflineMode('Switched to offline mode by user.'));

  window.addEventListener('DOMContentLoaded', function() {
    loadDatabaseFromGitHub();
  });

  // ======= SUPPLIER MID LOOKUP HELPERS =======
  function stripDiacritics(s){ 
    try { return s.normalize('NFKD').replace(/[\u0300-\u036f]/g,''); } 
    catch(_) { return s; } 
  }

  function normalizeSupplierName(s){
    return stripDiacritics(String(s||''))
      .toLowerCase()
      .replace(/&/g,' and ')
      .replace(/\b(gmbh|co\.?|kg|llc|inc\.?|ltd\.?|company|coatings|industrie|lackfabrik|the|and|of|factory|fabrik|sa|ag|gebr|geb\.)\b/gi,'')
      .replace(/[^a-z0-9]+/g,'')
      .trim();
  }

  function onlyConsonants(s){ return String(s||'').replace(/[aeiou]/gi,''); }

  function diceCoefficient(a,b){
    if(!a || !b) return 0;
    if(a === b) return 1;
    const grams = t => { const r=[]; for(let i=0;i<t.length-1;i++) r.push(t.slice(i,i+2)); return r; };
    const A=grams(a), B=grams(b);
    if(!A.length || !B.length) return 0;
    const map={}; let hit=0;
    A.forEach(g=>map[g]=(map[g]||0)+1);
    B.forEach(g=>{ if(map[g]){ hit++; map[g]--; }});
    return (2*hit)/(A.length+B.length);
  }

  function buildSupplierMidIndex(){
    supplierMidIndex = [];
    if(!Array.isArray(supplierMidDb)) return;
    supplierMidDb.forEach(row=>{
      const rawName = String(row['MANUFACTURERNAME'] ?? '').trim();
      const rawMid  = String(row['MANUFACTURERID'] ?? '').trim();
      if(!rawName || !rawMid) return;
      const norm = normalizeSupplierName(rawName);
      supplierMidIndex.push({ raw: rawName, norm, cons: onlyConsonants(norm), mid: rawMid });
    });
  }

  function scoreSupplierCandidate(qNorm, qRaw, rec){
    const exact = qNorm === rec.norm ? 1 : 0;
    const starts = rec.norm.startsWith(qNorm) ? 0.95 : 0;
    const contains = rec.norm.includes(qNorm) || qNorm.includes(rec.norm) ? 0.85 : 0;
    const dice = diceCoefficient(qNorm, rec.norm);
    const qCons = onlyConsonants(qNorm);
    const consDice = diceCoefficient(qCons, rec.cons);
    let shortBoost = 0;
    if(qNorm.length >= 3 && qNorm.length <= 6){
      if(rec.norm.includes(qNorm)) shortBoost = 0.25;
      else if(rec.cons.includes(qCons)) shortBoost = 0.18;
    }
    const rawContains = stripDiacritics(rec.raw).toLowerCase().includes(stripDiacritics(qRaw).toLowerCase()) ? 0.2 : 0;
    return Math.max(exact, starts, contains, dice, consDice) + shortBoost + rawContains;
  }

  function lookupSupplierMIDFromText(userSupplierText){
    if(!userSupplierText) return '';
    if(!supplierMidIndex.length) return '';
    const qRaw  = String(userSupplierText||'').trim();
    const qNorm = normalizeSupplierName(qRaw);
    if(!qNorm) return '';
    let best = { score: 0, mid: '' };
    for(const rec of supplierMidIndex){
      const s = scoreSupplierCandidate(qNorm, qRaw, rec);
      if(s > best.score) best = { score: s, mid: rec.mid };
    }
    const thresh = (qNorm.length <= 6) ? 0.38 : 0.45;
    return best.score >= thresh ? best.mid : '';
  }

  // ======= TARIFF LOOKUP HELPERS =======
  function extractBasePartNumber(fullPartNum){
    const s = String(fullPartNum || '').trim();
    const head = s.split('.')[0];
    const alnum = (head.match(/[A-Za-z0-9]+/)||[''])[0];
    if (alnum.length >= 5) return alnum.slice(0,5);
    if (alnum.length === 4) return alnum;
    const fallback = (s.match(/[A-Za-z0-9]{4,5}/)||[''])[0];
    return fallback || alnum || '';
  }

  function lookupTariffs(basePartNum){
    if(!grassDb || !grassDb.length) return [];
    const part = grassDb.find(row => String(row['PRIMARY PART NUM']) === basePartNum);
    if(!part) return [];
    const tariffs = [];
    
    // Check TARIFF NUM column first
    if(part['TARIFF NUM']){
      const tariffStr = String(part['TARIFF NUM']).replace(/\.0$/, '');
      tariffs.push(tariffStr);
    }
    
    // Then check TARIFF NUM_1 through TARIFF NUM_5
    for(let i=1; i<=5; i++){
      const col = `TARIFF NUM_${i}`;
      if(part[col]){
        const tariffStr = String(part[col]).replace(/\.0$/, '');
        tariffs.push(tariffStr);
      }
    }
    return tariffs;
  }

  function lookupHtsUom(htsCode){
    if(!htsCodesDb || !htsCodesDb.length) return {uom1: '', uom2: ''};
    const hts = htsCodesDb.find(row => String(row['HTS Code']) === String(htsCode));
    if(!hts) return {uom1: '', uom2: ''};
    return { uom1: hts['UOM1'] || '', uom2: hts['UOM2'] || '' };
  }

  function getSteelAlumPartNumber(tariff, type){
    if(!steelAlumDb || !steelAlumDb.length) return type === 'Steel' ? 'STEEL GENERIC' : 'ALUM GENERIC';
    const mapping = steelAlumDb.find(row => String(row['Tariff']).replace(/\.0$/, '') === String(tariff));
    if(mapping) return type === 'Steel' ? mapping['Steel'] : mapping['Aluminum'];
    return type === 'Steel' ? 'STEEL GENERIC' : 'ALUM GENERIC';
  }

  function computeExportUnitPrice(item){
    const q = parseFloat(item.quantity);
    const t = parseFloat(item.line_total);
    if (!isNaN(q) && q > 0 && !isNaN(t)) {
      return (t / q).toFixed(6);
    }
    return '';
  }

  // ======= UI EVENT WIRING =======
  UI.drop.addEventListener('click', ()=>UI.file.click());
  UI.drop.addEventListener('dragover', e=>{e.preventDefault();e.stopPropagation();UI.drop.classList.add('dragover');});
  UI.drop.addEventListener('dragleave',e=>{e.preventDefault();e.stopPropagation();UI.drop.classList.remove('dragover');});
  UI.drop.addEventListener('drop', e=>{
    e.preventDefault();e.stopPropagation();
    UI.drop.classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if(f) loadPdf(f);
  });
  UI.file.addEventListener('change', e=>{ if(e.target.files[0]) loadPdf(e.target.files[0]); });


  UI.exportBtn.addEventListener('click', exportToDescartes);
  UI.newBtn.addEventListener('click', ()=>location.reload());
  UI.undoBtn.addEventListener('click', undoLast);

  function pushUndo(){
    try{ undoStack.push(JSON.stringify({ALL,CURRENT})); if(undoStack.length>50)undoStack.shift(); }catch(e){}
  }
  function undoLast(){
    if(!undoStack.length){ showAlert('Nothing to undo',false); return; }
    try{
      const snap = JSON.parse(undoStack.pop());
      ALL = snap.ALL || [];
      CURRENT = snap.CURRENT || CURRENT;
      draw();
      showAlert('Undid last action',true);
    }catch(e){ console.error('Undo failed:',e); showAlert('Undo failed',false); }
  }

  function showAlert(msg, ok){
    UI.alert.textContent = msg;
    UI.alert.className = ok ? 'alert ok' : 'alert err';
    setTimeout(()=> UI.alert.className='alert', 4000);
  }


  function fmt2(n){ return Number(n||0).toFixed(2); }





  // ======= DESCARTES EXPORT WITH COMPLETE FUNCTIONALITY =======
  function exportToDescartes(){
    if(!ALL.length){
      showAlert('No data to export', false);
      return;
    }

    const items = ALL.slice().sort((a,b)=>{
      const ai = String(a.invoice_number||''); const bi = String(b.invoice_number||'');
      if (ai !== bi) return ai.localeCompare(bi);
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn;
      return (A[2]||'').localeCompare(B[2]||'');
    });

    const roundWeight = (val) => {
      const num = parseFloat(val);
      if (isNaN(num)) return '';
      if (num < 1 && num > 0) return 1;
      if (num <= 0) return '';
      return Math.round(num);
    };

    const currentUiSupplierByInvoice = {};
    try{
      const uiSupplier = UI.supplierInp?.value || '';
      const uiInvoice  = CURRENT || '';
      if(uiInvoice){ currentUiSupplierByInvoice[uiInvoice] = uiSupplier; }
    }catch(_){}
    items.forEach(rec=>{
      const inv = rec.invoice_number;
      if(!currentUiSupplierByInvoice[inv]) currentUiSupplierByInvoice[inv] = rec.supplier || '';
    });

    const exportRows = [];
    items.forEach(item => {
      const isSteelLine = String(item.position||'').endsWith('S');
      const isAlumLine  = String(item.position||'').endsWith('A');

      let buyerPartNum, supplierPartNum;
      if (!isSteelLine && !isAlumLine) {
        const basePart = extractBasePartNumber(item.part_number);
        buyerPartNum = basePart;
        supplierPartNum = basePart;
      } else {
        const parentPos = String(item.position||'').replace(/[SA]$/,'');
        const parentItem = items.find(it => it.invoice_number===item.invoice_number && it.position === parentPos);
        let tariffForSubline = null;
        if (parentItem) {
          const parentBase = extractBasePartNumber(parentItem.part_number);
          const parentTariffs = lookupTariffs(parentBase);
          tariffForSubline = parentTariffs.find(t => !String(t).startsWith('98') && !String(t).startsWith('99')) || null;
        }
        const subNum = tariffForSubline
          ? getSteelAlumPartNumber(tariffForSubline, isSteelLine ? 'Steel' : 'Aluminum')
          : (isSteelLine ? 'STEEL GENERIC' : 'ALUM GENERIC');
        buyerPartNum = subNum;
        supplierPartNum = subNum;
      }

      const supplierForInvoice = (currentUiSupplierByInvoice[item.invoice_number] || item.supplier || '');
      
      const row = {
        'InvoiceNumber': item.invoice_number || '',
        'InvoiceDate': item.invoice_date || '',
        'InvoiceTotal': item.invoice_total || '',
        'SupplierMID': lookupSupplierMIDFromText(supplierForInvoice),
        'SupplierName': supplierForInvoice,
        'BuyerPartNumber': buyerPartNum,
        'SupplierPartNumber': supplierPartNum,
        'Quantity': item.quantity || '',
        'UnitOfMeasure': item.unit || '',
        'Description': '',
        'UnitPrice': computeExportUnitPrice(item),
        'ItemTotal': item.line_total || '',
        'CurrencyCode': 'USD',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin || '',
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': roundWeight(item.net_weight),
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': ''
      };

      // Special handling for steel/aluminum sublines
      if (isSteelLine || isAlumLine) {
        row['NetWeight'] = roundWeight(item.quantity);
      }

      // Tariff lookups for non-steel/aluminum lines
      if (!isSteelLine && !isAlumLine) {
        const basePartNum = extractBasePartNumber(item.part_number);
        const tariffs = lookupTariffs(basePartNum);
        const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];

        tariffs.forEach((tariff, idx) => {
          if(idx < tariffFields.length){
            row[tariffFields[idx]] = tariff;
            const startsWithExempt = String(tariff).startsWith('98') || String(tariff).startsWith('99');
            if(!startsWithExempt){
              const uomInfo = lookupHtsUom(tariff);
              if(idx === 0){
                row['Quantity1'] = roundWeight(item.net_weight);
                row['UnitOfMeasure1'] = uomInfo.uom1;
                if(uomInfo.uom2){ row['Quantity2'] = roundWeight(item.net_weight); row['UnitOfMeasure2'] = uomInfo.uom2; }
              } else if(idx === 1){
                row['Secondary Quantity1'] = roundWeight(item.net_weight);
                row['Secondaryunitofmeasure1'] = uomInfo.uom1;
                if(uomInfo.uom2){ row['secondaryquantity2'] = roundWeight(item.net_weight); row['secondaryunitofmeasure2'] = uomInfo.uom2; }
              } else if(idx === 2){
                row['ThirdTariffQuantity1'] = roundWeight(item.net_weight);
                row['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
                if(uomInfo.uom2){ row['ThirdTariffQuantity2'] = roundWeight(item.net_weight); row['ThirdTariffUnitofMeasure2'] = uomInfo.uom2; }
              } else if(idx === 3){
                row['4TariffQuantity1'] = roundWeight(item.net_weight);
                row['4TariffUnitofMeasure1'] = uomInfo.uom1;
                if(uomInfo.uom2){ row['4TariffQuantity2'] = roundWeight(item.net_weight); row['4TariffUnitofMeasure2'] = uomInfo.uom2; }
              } else if(idx === 4){
                row['5TariffQuantity1'] = roundWeight(item.net_weight);
                row['5TariffUnitofMeasure1'] = uomInfo.uom1;
                if(uomInfo.uom2){ row['5TariffQuantity2'] = roundWeight(item.net_weight); row['5TariffUnitofMeasure2'] = uomInfo.uom2; }
              }
            }
          }
        });
      }

      // Override tariffs for steel lines
      if (isSteelLine) {
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038191';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      // Override tariffs for aluminum lines
      if (isAlumLine) {
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038508';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      exportRows.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportRows);
    XLSX.utils.book_append_sheet(wb, ws, 'DescartesUpload');

    const out  = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {
      type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href    = url;
    a.download = (filename? filename + '_' : '') + 'descartes_ci_upload.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('Descartes template exported successfully!', true);
  }
</script>
</body>
</html>
