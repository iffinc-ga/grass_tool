<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grass Invoice PDF Parser â€” Steel-only + Undo</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:1800px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{padding:28px 32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .header h1{font-size:22px;font-weight:800;margin-bottom:6px}
    .header p{opacity:.9}

    .db-banner{padding:8px 28px 0 28px;font-size:13px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .db-status{font-weight:600}
    .db-status.loading{color:#92400e}
    .db-status.loaded{color:#065f46}
    .db-status.offline{color:#4b5563}
    .db-info{color:#6b7280;font-size:12px}
    .db-btn{padding:4px 10px;border-radius:999px;border:0;background:#e5e7eb;font-size:11px;cursor:pointer}

    .upload{padding:28px}
    .drop{border:2px dashed #c7d2fe;border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:.2s}
    .drop:hover{background:#f8fafc}
    #fileInput{display:none}
    .loading{padding:28px;display:none;text-align:center}
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #6366f1;border-radius:50%;width:44px;height:44px;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bar{display:flex;gap:12px;align-items:center;padding:16px 20px;background:#f8fafc;border-top:1px solid #eef2ff;border-bottom:1px solid #eef2ff;flex-wrap:wrap}
    .bar select,.bar input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;min-width:220px}
    .bar button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    .bar .ghost{background:#eef2ff;color:#111}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px 20px;background:#fff}
    .stat{border:1px solid #eef2ff;border-radius:12px;padding:12px}
    .stat .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin-bottom:6px}
    .stat .val{font-size:18px;font-weight:800}

    .table{border-top:1px solid #eef2ff}
    .thead{background:#111;color:#fff;overflow:auto}
    .tbody{max-height:62vh;overflow:auto}
    .thead table,.tbody table{width:100%;table-layout:fixed;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-align:left}
    td input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:8px}
    .readonly{background:#f3f4f6}
    .actions{white-space:nowrap}
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
    .btn.del{background:#fee2e2}
    .btn.add{background:#dbeafe}
    .col-pos{width:64px}.col-part{width:260px}.col-qty{width:100px}.col-unit{width:72px}
    .col-price{width:120px}.col-total{width:130px}.col-weight{width:120px}.col-coo{width:80px}.col-act{width:160px}

    .alert{display:none;margin:12px 20px;padding:10px 12px;border-radius:10px;border:1px solid}
    .alert.ok{display:block;background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .alert.err{display:block;background:#fef2f2;border-color:#fecaca;color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Grass Invoice PDF Parser</h1>
      <p>Only steel sublines are kept. Base line total = original invoice total âˆ’ sum of steel sublines.</p>
    </div>

    <!-- DB banner -->
    <div class="db-banner">
      <span id="dbStatus" class="db-status loading">DB: not loaded</span>
      <span id="dbInfo" class="db-info">Will try to load updated_grass_db.xlsx from GitHub or local fileâ€¦</span>
      <button id="retryDbBtn" class="db-btn">Retry DB</button>
      <button id="offlineDbBtn" class="db-btn">Work offline</button>
    </div>

    <div class="upload" id="upload">
      <div class="drop" id="drop">
        <h3>ðŸ“¤ Click or Drag & Drop a PDF</h3>
        <p style="margin-top:6px;color:#6b7280">Optimized for Grass consolidated invoice format. Multiple invoices supported.</p>
        <input id="fileInput" type="file" accept="application/pdf,.pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Parsing PDF textâ€¦</strong></div>
    </div>

    <div class="alert" id="alert"></div>

    <div class="bar" id="bar" style="display:none">
      <select id="invoiceSel"><option value="">Select an invoiceâ€¦</option></select>
      <input id="supplierInp" placeholder="Supplier (edit)" />
      <input id="dateInp" placeholder="Invoice Date MM/DD/YYYY" />
      <input id="totalInp" type="number" step="0.01" placeholder="Invoice Total (USD)" />
      <button id="exportBtn">Export</button>
      <button id="undoBtn" class="ghost">Undo last change</button>
      <button id="newBtn" class="ghost">New Upload</button>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="label">Invoice</div><div class="val" id="stInv">-</div></div>
      <div class="stat"><div class="label">Items</div><div class="val" id="stItems">0</div></div>
      <div class="stat"><div class="label">Invoice Total</div><div class="val" id="stTotal">$0.00</div></div>
      <div class="stat"><div class="label">Sum of Lines</div><div class="val" id="stSum">$0.00</div></div>
      <div class="stat"><div class="label">Difference</div><div class="val" id="stDiff">$0.00</div></div>
    </div>

    <div class="table" id="table" style="display:none">
      <div class="thead" id="thead">
        <table><thead><tr>
          <th class="col-pos">Pos</th>
          <th class="col-part">Part Number / Description</th>
          <th class="col-qty">Quantity</th>
          <th class="col-unit">Unit</th>
          <th class="col-price">Unit Price</th>
          <th class="col-total">Line Total</th>
          <th class="col-weight">Net Weight (kg)</th>
          <th class="col-coo">COO</th>
          <th class="col-act">Actions</th>
        </tr></thead></table>
      </div>
      <div class="tbody" id="tbody">
        <table><tbody id="rows"></tbody></table>
      </div>
    </div>
  </div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const UI = {
    upload: $('#upload'), drop: $('#drop'), file: $('#fileInput'), loading: $('#loading'),
    alert: $('#alert'), bar: $('#bar'), invSel: $('#invoiceSel'),
    supplierInp: $('#supplierInp'), dateInp: $('#dateInp'), totalInp: $('#totalInp'),
    stats: $('#stats'), stInv: $('#stInv'), stItems: $('#stItems'),
    stTotal: $('#stTotal'), stSum: $('#stSum'), stDiff: $('#stDiff'),
    table: $('#table'), thead: $('#thead'), tbody: $('#tbody'),
    rows: $('#rows'), exportBtn: $('#exportBtn'), newBtn: $('#newBtn'),
    undoBtn: $('#undoBtn')
  };

  let ALL = [], ORDER = [], CURRENT = '', filename = '';
  let grassDb = [], htsCodesDb = [], steelAlumDb = [];
  let supplierMidDb = [], supplierMidIndex = [];
  let undoStack = [];
  let pendingFocusPos = null;

  // ===== DB loader =====
  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo:  'all_in_one_manki',
    branch:'main',
    filePath: 'updated_grass_db.xlsx'
  };

  const dbStatusEl    = document.getElementById('dbStatus');
  const dbInfoEl      = document.getElementById('dbInfo');
  const retryDbBtn    = document.getElementById('retryDbBtn');
  const offlineDbBtn  = document.getElementById('offlineDbBtn');

  function setDbBanner(state,msg,info){
    if(!dbStatusEl) return;
    let cls = 'db-status';
    if(state==='loading') cls+=' loading';
    else if(state==='loaded') cls+=' loaded';
    else if(state==='offline') cls+=' offline';
    dbStatusEl.className = cls;
    dbStatusEl.textContent = msg;
    if(dbInfoEl && info!=null) dbInfoEl.textContent = info;
  }

  function abortableFetch(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    return fetch(url,{signal:ctrl.signal}).finally(()=>clearTimeout(t));
  }

  async function fetchAndReadWorkbook(url, useAbort){
    const res = useAbort ? await abortableFetch(url,8000) : await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf,{type:'array'});
  }

  async function hydrateDbFromWorkbook(workbook){
    const grassSheetName =
      workbook.SheetNames.find(n => n.toLowerCase().includes('grass')) ||
      workbook.SheetNames[0];
    grassDb = XLSX.utils.sheet_to_json(workbook.Sheets[grassSheetName], {defval:''});
    console.log(`[DB] Loaded ${grassSheetName}: ${grassDb.length} rows`);

    if(workbook.SheetNames.includes('hts_codes_with_uom')){
      htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets['hts_codes_with_uom']);
      console.log(`[DB] Loaded hts_codes_with_uom: ${htsCodesDb.length} rows`);
    }

    if(workbook.SheetNames.includes('Sheet1')){
      steelAlumDb = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1']);
      console.log(`[DB] Loaded Sheet1: ${steelAlumDb.length} rows`);
    }

    if(workbook.SheetNames.includes('MID')){
      supplierMidDb = XLSX.utils.sheet_to_json(workbook.Sheets['MID'], {defval:''});
      buildSupplierMidIndex();
      console.log(`[DB] Loaded MID: ${supplierMidDb.length} rows`);
    }
  }

  function enterOfflineMode(reason){
    grassDb = grassDb || [];
    htsCodesDb = htsCodesDb || [];
    steelAlumDb = steelAlumDb || [];
    supplierMidDb = supplierMidDb || [];
    supplierMidIndex = supplierMidIndex || [];
    setDbBanner('offline','DB: offline', reason || 'Proceeding without DB enrichment.');
  }

  async function loadDatabaseFromGitHub(){
    const {owner,repo,branch,filePath} = GITHUB_CONFIG;
    const remoteUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
    const localUrl  = './updated_grass_db.xlsx';

    setDbBanner('loading','DB: loadingâ€¦','Trying GitHub (8s timeout)â€¦');

    try{
      const wb = await fetchAndReadWorkbook(remoteUrl,true);
      await hydrateDbFromWorkbook(wb);
      setDbBanner('loaded','DB: loaded from GitHub', new Date().toLocaleString());
      return;
    }catch(err1){
      console.warn('[DB] GitHub load failed', err1?.message || err1);
      setDbBanner('loading','DB: retrying from localâ€¦','Looking for ./updated_grass_db.xlsx');
      try{
        const wb2 = await fetchAndReadWorkbook(localUrl,false);
        await hydrateDbFromWorkbook(wb2);
        setDbBanner('loaded','DB: loaded from local', new Date().toLocaleString());
        return;
      }catch(err2){
        console.warn('[DB] Local db load failed', err2?.message || err2);
        enterOfflineMode('DB could not be loaded from GitHub or local file.');
      }
    }
  }

  retryDbBtn?.addEventListener('click', ()=> loadDatabaseFromGitHub().catch(()=>{}));
  offlineDbBtn?.addEventListener('click', ()=> enterOfflineMode('Offline mode selected by user.'));
  window.addEventListener('DOMContentLoaded', ()=>{ loadDatabaseFromGitHub().catch(()=>{}); });

  // ===== Utility helpers =====
  function showAlert(msg, ok=true){
    UI.alert.className = 'alert ' + (ok?'ok':'err');
    UI.alert.textContent = msg;
    UI.alert.style.display='block';
    setTimeout(()=> UI.alert.style.display='none', 3200);
  }

  function parseNum(s){
    if(s==null) return NaN;
    const t=String(s).trim();
    if(!t) return NaN;
    if(/\d+[.,]\d{3}[.,]\d{2}$/.test(t)){
      const last = t.lastIndexOf('.')>t.lastIndexOf(',')?'.':',';
      const intPart=t.slice(0,t.lastIndexOf(last)).replace(/[.,\s]/g,'');
      const dec=t.slice(t.lastIndexOf(last)+1);
      return parseFloat(intPart+'.'+dec);
    }
    if(/,\d{2}$/.test(t) && !/\.\d{2}$/.test(t))
      return parseFloat(t.replace(/\./g,'').replace(',','.'));
    return parseFloat(t.replace(/,/g,''));
  }

  const fmt2  = n => (isFinite(+n)? (+n).toFixed(2):'');
  const toUS  = d => {
    const m=String(d||'').match(/(\d{2})\.(\d{2})\.(\d{4})/);
    return m ? `${m[2]}/${m[1]}/${m[3]}` : (d||'');
  };
  const sumLines = list => list.reduce((a,r)=> a + (parseNum(r.line_total)||0), 0);

  function pushUndo(){
    undoStack.push(JSON.parse(JSON.stringify(ALL)));
    if(undoStack.length > 50) undoStack.shift();
  }

  function undoLast(){
    if(!undoStack.length){
      showAlert('Nothing to undo', false);
      return;
    }
    ALL = undoStack.pop() || [];
    ORDER = Array.from(new Set(ALL.map(r=>r.invoice_number)));
    if(!CURRENT || !ORDER.includes(CURRENT)) CURRENT = ORDER[0] || '';
    if(!ORDER.length){
      UI.table.style.display='none';
      UI.stats.style.display='none';
      return;
    }
    buildUI();
  }

  // ===== File handling =====
  UI.drop.addEventListener('click', ()=> UI.file.click());
  UI.file.addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(f) handleFile(f);
  });
  UI.drop.addEventListener('dragover', e=>{
    e.preventDefault();
    UI.drop.style.background='#f1f5ff';
  });
  UI.drop.addEventListener('dragleave', ()=>{
    UI.drop.style.background='';
  });
  UI.drop.addEventListener('drop', e=>{
    e.preventDefault();
    UI.drop.style.background='';
    const f=e.dataTransfer.files?.[0];
    if(f) handleFile(f);
  });
  UI.newBtn.addEventListener('click', ()=> location.reload());
  UI.undoBtn.addEventListener('click', undoLast);

  async function handleFile(file){
    if(!/\.pdf$/i.test(file.name)){
      showAlert('Please upload a PDF file', false);
      return;
    }
    filename = file.name.replace(/\.pdf$/i,'');
    UI.upload.style.display='none';
    UI.loading.style.display='block';
    undoStack = [];

    try{
      const buf = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let text = '';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const tc = await page.getTextContent({includeMarkedContent:true});
          text += (tc.items||[]).map(it=> it?.str || '').join(' ') + "\n";
        }catch(e){
          console.warn('page read failed', i, e);
        }
      }
      if(!text.trim()){
        showAlert('PDF has no extractable text (maybe scanned). Try OCR.', false);
        UI.upload.style.display='block';
        return;
      }
      parseGrass(text);
      ORDER.forEach(id => applySteelAdjustments(id));

      if(ALL.length){
        buildUI();
        showAlert(
          `Found ${new Set(ALL.map(x=>x.invoice_number)).size} invoice(s), ${ALL.length} row(s)`,
          true
        );
      } else {
        showAlert('No invoice rows were parsed. Try another file or adjust patterns.', false);
        UI.upload.style.display='block';
      }
    }catch(err){
      console.error(err);
      showAlert('Error: '+(err.message||String(err)), false);
      UI.upload.style.display='block';
    } finally{
      UI.loading.style.display='none';
    }
  }

  // ===== Core Grass parsing (unchanged logic except requested steel net_weight tweak) =====
  function parseGrass(text){
    ALL.length = 0;
    ORDER.length = 0;
    const big = String(text||'');

    const invm = [...big.matchAll(/Invoice\s+(\d{5,})/gi)];
    const invNum = invm.length? invm[0][1] : 'UNKNOWN';
    if(!ORDER.includes(invNum)) ORDER.push(invNum);

    let invDate = '';
    const dm = big.match(/Date:\s*(\d{2}\.\d{2}\.\d{4})/);
    if(dm) invDate = toUS(dm[1]);

    let supplier = 'GRASS GmbH';
    if(/\bGRASS\s+GmbH\s+(Ã–sterreich|Osterreich)\b/i.test(big))
      supplier = 'GRASS GmbH Ã–sterreich';

    let invTotal = '';
    const tm = big.match(/Total\s+Amount\s+([\d.,]+)\s+USD/i);
    if(tm) invTotal = String(parseNum(tm[1])||'');

    const itemRegex =
      /\b(F[0-9]{9,})\s+(\d+[\d.,]*)\s+(PCS|PC|SET|PAIRS?)\s+([\d.,]+)\s*\/\s*(\d+)\s+([\d.,]+)\s+USD/gi;
    const items = [];
    let m;
    while((m = itemRegex.exec(big)) !== null){
      items.push({
        idx: m.index,
        part: m[1],
        qty: parseNum(m[2]),
        unit: m[3].toUpperCase(),
        unitPricePer: parseNum(m[4]),
        perDivisor: parseNum(m[5]),
        lineTotal: parseNum(m[6])
      });
    }

    const meta = items.map(()=>({ baseNetkg: NaN, netkgStr:'', coo:'' }));
    items.forEach((it, i)=>{
      const start = it.idx;
      const end   = (i < items.length-1 ? items[i+1].idx : big.length);
      const slab  = big.slice(start, end);

      const wM = slab.match(/Net\s*weight\s*in\s*kg:\s*([\d.,]+)/i);
      if(wM){
        const base = parseNum(wM[1]);
        if(isFinite(base)){
          meta[i].baseNetkg = base;
          meta[i].netkgStr  = fmt2(base);
        }
      }
      const cooM = slab.match(/Country\s+of\s+Origin:\s*([A-Z]{2})/i);
      if(cooM){
        meta[i].coo = cooM[1].toUpperCase();
      }
    });

    const steelInfo = items.map(()=>({ steelKG:NaN, steelVal:NaN }));
    const usedBlockIdx = new Set();

    const blockRegex =
      /Net\s*weight\s*in\s*kg\s*in\s*steel\s*:\s*([\d.,]+)\s*Net\s*weight\s*in\s*kg\s*in\s*other\s*:\s*([\d.,]+)\s*Steel\s*value\s*:\s*([\d.,]+)\s*Other\s*value\s*:\s*([\d.,]+)/gi;
    let mb;
    while((mb = blockRegex.exec(big)) !== null){
      const blockIdx = mb.index;
      const steelKG = parseNum(mb[1]);
      const otherKG = parseNum(mb[2]);
      const steelVal = parseNum(mb[3]);
      const otherVal = parseNum(mb[4]);

      const blockNet = (isFinite(steelKG)?steelKG:0) + (isFinite(otherKG)?otherKG:0);
      const blockVal = (isFinite(steelVal)?steelVal:0) + (isFinite(otherVal)?otherVal:0);
      if(!isFinite(blockNet) || !isFinite(blockVal)) continue;

      let bestIdx = -1;
      let bestScore = Infinity;

      items.forEach((it, i)=>{
        const baseNet = meta[i].baseNetkg;
        const baseVal = it.lineTotal;
        if(!isFinite(baseNet) || !isFinite(baseVal)) return;

        const netDiff = Math.abs(baseNet - blockNet);
        const valDiff = Math.abs(baseVal - blockVal);
        const netRel = netDiff / Math.max(Math.abs(baseNet), Math.abs(blockNet), 1);
        const valRel = valDiff / Math.max(Math.abs(baseVal), Math.abs(blockVal), 1);
        if(netRel > 0.01 || valRel > 0.01) return;

        const dist = Math.abs(blockIdx - it.idx);
        const score = netRel + valRel + dist / 1_000_000;
        if(score < bestScore){
          bestScore = score;
          bestIdx = i;
        }
      });

      if(bestIdx >= 0){
        usedBlockIdx.add(blockIdx);
        const info = steelInfo[bestIdx];
        if(isFinite(steelKG)){
          info.steelKG = isFinite(info.steelKG) ? (info.steelKG + steelKG) : steelKG;
        }
        if(isFinite(steelVal)){
          info.steelVal = isFinite(info.steelVal) ? (info.steelVal + steelVal) : steelVal;
        }
      }
    }

    const steelOnlyRegex =
      /Net\s*weight\s*in\s*kg\s*in\s*steel\s*:\s*([\d.,]+)[\s\S]{0,120}?Steel\s*value\s*:\s*([\d.,]+)/gi;
    let so;
    while((so = steelOnlyRegex.exec(big)) !== null){
      const idx = so.index;
      if(usedBlockIdx.has(idx)) continue;

      const steelKG = parseNum(so[1]);
      const steelVal = parseNum(so[2]);
      if(!isFinite(steelKG) && !isFinite(steelVal)) continue;

      let bestIdx = -1;
      let bestRel = Infinity;
      let bestDist = Infinity;

      items.forEach((it, i)=>{
        const baseNet = meta[i].baseNetkg;
        if(!isFinite(baseNet)) return;
        if(idx <= it.idx) return;

        const netRel = Math.abs(baseNet - steelKG) / Math.max(Math.abs(baseNet), Math.abs(steelKG), 1);
        if(netRel > 0.6) return;

        const dist = idx - it.idx;
        if(netRel < bestRel - 1e-9 || (Math.abs(netRel - bestRel) < 1e-9 && dist < bestDist)){
          bestRel = netRel;
          bestDist = dist;
          bestIdx = i;
        }
      });

      if(bestIdx >= 0){
        const info = steelInfo[bestIdx];
        if(isFinite(steelKG)){
          info.steelKG = isFinite(info.steelKG) ? (info.steelKG + steelKG) : steelKG;
        }
        if(isFinite(steelVal)){
          info.steelVal = isFinite(info.steelVal) ? (info.steelVal + steelVal) : steelVal;
        }
      }
    }

    if(!items.length){
      ALL.push({
        invoice_number:invNum, invoice_date:invDate, supplier, invoice_total:invTotal,
        position:'', part_number:'', quantity:'', unit:'', unit_price:'',
        line_total:'', net_weight:'', country_of_origin:''
      });
      return;
    }

    items.forEach((it, i)=>{
      const pos = (i+1).toString();
      const baseNetkg = meta[i].baseNetkg;
      const netkgStr  = meta[i].netkgStr;
      const coo       = meta[i].coo;
      const baseVal   = it.lineTotal;

      const unitPrice =
        (isFinite(it.unitPricePer) && isFinite(it.perDivisor) && it.perDivisor>0)
          ? (it.unitPricePer / it.perDivisor)
          : '';

      const origLineTotal = isFinite(baseVal) ? fmt2(baseVal) : '';

      ALL.push({
        invoice_number: invNum,
        invoice_date:  invDate,
        supplier,
        invoice_total: invTotal,
        position: pos,
        part_number: it.part,
        quantity: isFinite(it.qty)? fmt2(it.qty) : '',
        unit: it.unit,
        unit_price: isFinite(unitPrice) ? fmt2(unitPrice) : '',
        line_total: origLineTotal,
        _origLineTotal: origLineTotal,
        net_weight: netkgStr,
        country_of_origin: coo
      });

      let sInfo = steelInfo[i];
      let sVal  = sInfo.steelVal;
      let sKG   = sInfo.steelKG;

      if(isFinite(sVal) && sVal > 0){
        if(isFinite(baseVal) && baseVal > 0 && sVal > baseVal){
          const ratio = baseVal / sVal;
          sVal = baseVal;
          if(isFinite(sKG)) sKG = sKG * ratio;
        }

        // NEW: compute steel content line net_weight as baseNetkg - steelKG (if both known)
        let steelLineNet = NaN;
        if (isFinite(baseNetkg) && isFinite(sKG)) {
          steelLineNet = baseNetkg - sKG;
        }

        ALL.push({
          invoice_number: invNum,
          invoice_date:  invDate,
          supplier,
          invoice_total: invTotal,
          position: pos + 'S',
          part_number: 'Steel - ' + it.part,
          quantity: isFinite(sKG)? fmt2(sKG):'',
          unit:'KG',
          unit_price:'',
          line_total: fmt2(sVal),
          net_weight: isFinite(steelLineNet) ? fmt2(steelLineNet) : '',
          country_of_origin: coo,
          origin: 'auto_steel'
        });
      }
    });
  }

  // ===== Keyboard navigation =====
  function focusNext(current, dir){
    const inputs = [
      UI.invSel, UI.supplierInp, UI.dateInp, UI.totalInp,
      ...$$('#rows input')
    ].filter(Boolean);
    const idx = inputs.indexOf(current);
    const nextIdx = Math.max(0, Math.min(inputs.length-1, idx + (dir||1)));
    const target = inputs[nextIdx];
    if(target){
      target.focus();
      if(target.select) target.select();
    }
  }

  function attachNavHandlers(inp){
    if(!inp) return;
    inp.addEventListener('keydown', ev=>{
      if(ev.key === 'Enter'){
        ev.preventDefault();
        focusNext(inp, ev.shiftKey ? -1 : 1);
      }
    });
  }

  // ===== UI building & editing =====
  function buildUI(){
    UI.bar.style.display='flex';
    const header = UI.thead, body = UI.tbody;
    let sync=false;
    body.addEventListener('scroll',()=>{
      if(sync) return;
      sync=true;
      header.scrollLeft = body.scrollLeft;
      sync=false;
    });

    UI.invSel.innerHTML = '<option value="">Select an invoiceâ€¦</option>';
    const metaInv = {};
    ALL.forEach(r=>{
      if(!metaInv[r.invoice_number]) metaInv[r.invoice_number] = {
        date:r.invoice_date, supplier:r.supplier, total:r.invoice_total, count:0
      };
      metaInv[r.invoice_number].count++;
    });

    ORDER = Array.from(new Set(ALL.map(r=>r.invoice_number)));
    ORDER.forEach(id=>{
      const m = metaInv[id]||{date:'',supplier:'',total:'',count:0};
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent =
        `Invoice ${id} â€” ${m.count} items â€” ${m.date} â€” ${m.supplier} â€” $${Number(m.total||0).toFixed(2)}`;
      UI.invSel.appendChild(opt);
    });

    UI.invSel.onchange = ()=>{
      CURRENT = UI.invSel.value;
      if(CURRENT) renderInvoice(CURRENT);
    };
    UI.exportBtn.onclick = exportToDescartes;

    if(!CURRENT) CURRENT = ORDER[0];
    UI.invSel.value = CURRENT;
    if(CURRENT) renderInvoice(CURRENT);

    UI.invSel.tabIndex = 1;
    UI.supplierInp.tabIndex = 2;
    UI.dateInp.tabIndex = 3;
    UI.totalInp.tabIndex = 4;
    attachNavHandlers(UI.invSel);
    attachNavHandlers(UI.supplierInp);
    attachNavHandlers(UI.dateInp);
    attachNavHandlers(UI.totalInp);
  }

  function sortedRowsForCurrent(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn;
      return (A[2]||'').localeCompare(B[2]||'');
    });
    return rows;
  }

  function renderInvoice(id){
    const rows = sortedRowsForCurrent();
    const meta = rows[0]||{};

    UI.supplierInp.value = meta.supplier||'';
    UI.dateInp.value     = meta.invoice_date||'';
    UI.totalInp.value    = meta.invoice_total||'';

    UI.stInv.textContent   = id;
    UI.stItems.textContent = String(rows.length);
    UI.stTotal.textContent = '$'+Number(meta.invoice_total||0).toFixed(2);

    UI.rows.innerHTML = '';
    rows.forEach((r, idx)=>{
      const tr = renderRow(r, idx);
      tr.dataset.pos = r.position || '';
      tr.dataset.origin = r.origin || '';
      UI.rows.appendChild(tr);
    });

    UI.table.style.display='block';
    UI.stats.style.display='grid';
    recomputeStats();

    UI.supplierInp.onchange = e=> { pushUndo(); updateHdr('supplier', e.target.value); };
    UI.dateInp.onchange     = e=> { pushUndo(); updateHdr('invoice_date', e.target.value); };
    UI.totalInp.onchange    = e=> { pushUndo(); updateHdr('invoice_total', e.target.value); recomputeStats(); };

    rebuildTabOrder();

    if(pendingFocusPos && id === CURRENT){
      const targetTr = Array.from(UI.rows.querySelectorAll('tr'))
        .find(tr => tr.dataset.pos === pendingFocusPos && tr.dataset.origin === 'manual_steel');
      if(targetTr){
        const posInput = targetTr.querySelector('td:first-child input');
        if(posInput){
          posInput.focus();
          posInput.select && posInput.select();
        }
      }
      pendingFocusPos = null;
    }
  }

  function renderRow(row, idx){
    const tr = document.createElement('tr');
    function cell(val, key, ro=false){
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.value = val==null? '' : String(val);
      if(ro){
        inp.className='readonly';
        inp.readOnly=true;
      }
      inp.onchange = ()=>{
        pushUndo();
        updateCell(idx, key, inp.value);
      };
      attachNavHandlers(inp);
      td.appendChild(inp);
      return td;
    }
    const actions = document.createElement('td');
    actions.className='actions';
    const add = document.createElement('button');
    add.className='btn add';
    add.textContent='âž• Below';
    add.onclick=()=> { pushUndo(); addBelow(idx); };
    const del = document.createElement('button');
    del.className='btn del';
    del.textContent='ðŸ—‘ï¸';
    del.onclick=()=> { pushUndo(); removeRow(idx); };
    actions.appendChild(add);
    actions.appendChild(del);

    tr.appendChild(cell(row.position,'position'));
    tr.appendChild(cell(row.part_number,'part_number'));
    tr.appendChild(cell(row.quantity,'quantity'));
    tr.appendChild(cell(row.unit,'unit'));
    tr.appendChild(cell(row.unit_price,'unit_price'));
    tr.appendChild(cell(row.line_total,'line_total'));
    tr.appendChild(cell(row.net_weight,'net_weight'));
    tr.appendChild(cell(row.country_of_origin,'country_of_origin'));
    tr.appendChild(actions);
    return tr;
  }

  function rebuildTabOrder(){
    let ti = 10;
    $$('#rows input').forEach(inp=>{ inp.tabIndex = ti++; });
  }

  function updateCell(viewIdx, key, val){
    const rows = sortedRowsForCurrent();
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){
      ALL[idx][key]=val;
      applySteelAdjustments(CURRENT);
      recomputeStats();
      syncCurrentInvoiceInputs();
    }
  }

  function syncCurrentInvoiceInputs(){
    const rows = sortedRowsForCurrent();
    const trs = Array.from(UI.rows.querySelectorAll('tr'));
    rows.forEach((row,i)=>{
      const tr = trs[i];
      if(!tr) return;
      const inputs = tr.querySelectorAll('input');
      const vals = [
        row.position ?? '',
        row.part_number ?? '',
        row.quantity ?? '',
        row.unit ?? '',
        row.unit_price ?? '',
        row.line_total ?? '',
        row.net_weight ?? '',
        row.country_of_origin ?? ''
      ];
      inputs.forEach((inp,j)=>{
        if(vals[j] !== undefined) inp.value = vals[j];
      });
    });
  }

  function addBelow(viewIdx){
    const rows = sortedRowsForCurrent();
    const base = rows[viewIdx];
    const baseNum = String(base.position||'').replace(/[A-Z]$/,'');
    const insert = {
      invoice_number: CURRENT,
      invoice_date: base.invoice_date,
      supplier: base.supplier,
      invoice_total: base.invoice_total,
      position: baseNum + 'S',
      part_number:'',
      quantity:'',
      unit:'',
      unit_price:'',
      line_total:'',
      net_weight:'',
      country_of_origin: base.country_of_origin,
      origin: 'manual_steel'
    };
    const idx = ALL.indexOf(base);
    ALL.splice(idx+1, 0, insert);
    pendingFocusPos = insert.position;
    applySteelAdjustments(CURRENT);
    renderInvoice(CURRENT);
  }

  function removeRow(viewIdx){
    const rows = sortedRowsForCurrent();
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){
      ALL.splice(idx,1);
      applySteelAdjustments(CURRENT);
      renderInvoice(CURRENT);
    }
  }

  function updateHdr(field, val){
    ALL.forEach(r=>{
      if(r.invoice_number===CURRENT){
        r[field]=val;
      }
    });
  }

  function recomputeStats(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT);
    const invTotal = parseNum(rows[0]?.invoice_total);
    const sum = sumLines(rows);
    UI.stTotal.textContent = '$'+(isFinite(invTotal)?invTotal.toFixed(2):'0.00');
    UI.stSum.textContent   = '$'+sum.toFixed(2);
    const diff = (isFinite(invTotal)?invTotal:0) - sum;
    UI.stDiff.textContent  = '$'+diff.toFixed(2);
  }

  function applySteelAdjustments(invId){
    if(!invId) return;
    const rows = ALL.filter(r=>r.invoice_number===invId);
    const groups = {};
    rows.forEach(r=>{
      const m = String(r.position||'').match(/^(\d+)([A-Z]?)$/);
      if(!m) return;
      const baseNum = m[1];
      const suffix = (m[2]||'').toUpperCase();
      if(!groups[baseNum]) groups[baseNum] = { base:null, steels:[] };
      if(!suffix){
        groups[baseNum].base = r;
      } else if(suffix === 'S'){
        groups[baseNum].steels.push(r);
      }
    });

    Object.values(groups).forEach(group=>{
      const base = group.base;
      if(!base) return;
      const orig = parseNum(base._origLineTotal || base.line_total);
      if(!isFinite(orig)) return;
      let steelSum = 0;
      group.steels.forEach(s=>{
        const v = parseNum(s.line_total);
        if(isFinite(v)) steelSum += v;
      });
      const newTotal = Math.max(0, orig - steelSum);
      base.line_total = fmt2(newTotal);
    });
  }

  // ===== Supplier MID lookup =====
  function stripDiacritics(s){
    try { return s.normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
    catch(_) { return s; }
  }

  function normalizeSupplierName(s){
    return stripDiacritics(String(s||''))
      .toLowerCase()
      .replace(/&/g,' and ')
      .replace(/\b(gmbh|co\.?|kg|llc|inc\.?|ltd\.?|company|coatings|industrie|lackfabrik|the|and|of|factory|fabrik|sa|ag|gebr|geb\.)\b/gi,'')
      .replace(/[^a-z0-9]+/g,'')
      .trim();
  }

  function onlyConsonants(s){ return String(s||'').replace(/[aeiou]/gi,''); }

  function diceCoefficient(a,b){
    if(!a || !b) return 0;
    if(a === b) return 1;
    const grams = t => { const r=[]; for(let i=0;i<t.length-1;i++) r.push(t.slice(i,i+2)); return r; };
    const A=grams(a), B=grams(b);
    if(!A.length || !B.length) return 0;
    const map={}; let hit=0;
    A.forEach(g=>map[g]=(map[g]||0)+1);
    B.forEach(g=>{ if(map[g]){ hit++; map[g]--; }});
    return (2*hit)/(A.length+B.length);
  }

  function buildSupplierMidIndex(){
    supplierMidIndex = [];
    if(!Array.isArray(supplierMidDb)) return;
    supplierMidDb.forEach(row=>{
      const rawName = String(row['MANUFACTURERNAME'] ?? '').trim();
      const rawMid  = String(row['MANUFACTURERID'] ?? '').trim();
      if(!rawName || !rawMid) return;
      const norm = normalizeSupplierName(rawName);
      supplierMidIndex.push({ raw: rawName, norm, cons: onlyConsonants(norm), mid: rawMid });
    });
  }

  function scoreSupplierCandidate(qNorm, qRaw, rec){
    const exact = qNorm === rec.norm ? 1 : 0;
    const starts = rec.norm.startsWith(qNorm) ? 0.95 : 0;
    const contains = rec.norm.includes(qNorm) || qNorm.includes(rec.norm) ? 0.85 : 0;
    const dice = diceCoefficient(qNorm, rec.norm);
    const qCons = onlyConsonants(qNorm);
    const consDice = diceCoefficient(qCons, rec.cons);
    let shortBoost = 0;
    if(qNorm.length >= 3 && qNorm.length <= 6){
      if(rec.norm.includes(qNorm)) shortBoost = 0.25;
      else if(rec.cons.includes(qCons)) shortBoost = 0.18;
    }
    const rawContains = stripDiacritics(rec.raw).toLowerCase().includes(stripDiacritics(qRaw).toLowerCase()) ? 0.2 : 0;
    return Math.max(exact, starts, contains, dice, consDice) + shortBoost + rawContains;
  }

  function lookupSupplierMIDFromText(userSupplierText){
    if(!userSupplierText) return '';
    if(!supplierMidIndex.length) return '';
    const qRaw  = String(userSupplierText||'').trim();
    const qNorm = normalizeSupplierName(qRaw);
    if(!qNorm) return '';
    let best = { score: 0, mid: '' };
    for(const rec of supplierMidIndex){
      const s = scoreSupplierCandidate(qNorm, qRaw, rec);
      if(s > best.score) best = { score: s, mid: rec.mid };
    }
    const thresh = (qNorm.length <= 6) ? 0.38 : 0.45;
    return best.score >= thresh ? best.mid : '';
  }

  // ===== Tariff helpers and ALL STEEL / STEEL EXCL logic =====
  function extractBasePartNumber(fullPartNum){
    const s = String(fullPartNum || '').trim();
    const head = s.split('.')[0];
    const alnum = (head.match(/[A-Za-z0-9]+/)||[''])[0];
    if (alnum.length >= 5) return alnum.slice(0,5);
    if (alnum.length === 4) return alnum;
    const fallback = (s.match(/[A-Za-z0-9]{4,5}/)||[''])[0];
    return fallback || alnum || '';
  }

  function findPartRow(partNumber){
    if(!grassDb || !grassDb.length) return null;
    const full = String(partNumber || '').trim();
    if(!full) return null;
    let row = grassDb.find(r => String(r['PRIMARY PART NUM'] ?? '').trim() === full);
    if(row) return row;
    const base = extractBasePartNumber(full);
    if(base){
      row = grassDb.find(r => String(r['PRIMARY PART NUM'] ?? '').trim() === base);
      if(row) return row;
    }
    return null;
  }

  function normalizeTariffValue(v){
    if(v === null || v === undefined || v === '') return '';
    const n = Number(v);
    if(!isNaN(n)){
      if(Number.isInteger(n)) return String(n);
      const rn = Math.round(n);
      if(Math.abs(rn - n) < 1e-6) return String(rn);
      return String(rn);
    }
    let s = String(v).trim();
    if(!s) return '';
    if(/e\+/i.test(s)){
      const f = Number(s);
      if(!isNaN(f)) return String(Math.round(f));
    }
    s = s.replace(/\.0$/,'');
    return s;
  }

  function gatherTariffsFromRow(row){
    const fields = ['TARIFF NUM','TARIFF NUM_1','TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4'];
    const out = [];
    fields.forEach(f=>{
      const raw = row[f];
      if(raw === undefined || raw === null || raw === '') return;
      const norm = normalizeTariffValue(raw);
      if(norm) out.push(norm);
    });
    return out;
  }

  function getMainTariffByPart(partNumber){
    const row = findPartRow(partNumber);
    if(!row) return '';
    const tariffs = gatherTariffsFromRow(row);
    if(!tariffs.length) return '';
    const non99 = tariffs.find(t => !/^99/.test(t) && !/^98/.test(t));
    return non99 || tariffs[0];
  }

  function getAllSteelPartForTariff(mainTariff){
    if(!grassDb || !grassDb.length) return 'ALL STEEL GENERIC';
    const normTariff = normalizeTariffValue(mainTariff);
    if(!normTariff) return 'ALL STEEL GENERIC';

    const allSteelRows = grassDb.filter(row => {
      const p = String(row['PRIMARY PART NUM'] ?? '').toUpperCase();
      return p.startsWith('ALL STEEL');
    });
    if(!allSteelRows.length) return 'ALL STEEL GENERIC';

    let match = allSteelRows.find(row => {
      const tariffs = gatherTariffsFromRow(row);
      return tariffs.includes(normTariff);
    });

    if(match){
      return String(match['PRIMARY PART NUM'] || 'ALL STEEL GENERIC');
    }

    const generic = allSteelRows.find(row =>
      String(row['PRIMARY PART NUM'] ?? '').toUpperCase().includes('ALL STEEL GENERIC')
    );
    if(generic) return String(generic['PRIMARY PART NUM']);
    return String(allSteelRows[0]['PRIMARY PART NUM'] || 'ALL STEEL GENERIC');
  }

  function lookupTariffsByPart(partNumber){
    const partRow = findPartRow(partNumber);
    if(!partRow) return [];
    return gatherTariffsFromRow(partRow);
  }

  function lookupHtsUom(htsCode){
    if(!htsCodesDb || !htsCodesDb.length) return {uom1: '', uom2: ''};
    const hts = htsCodesDb.find(row => String(row['HTS Code']) === String(htsCode));
    if(!hts) return {uom1: '', uom2: '' };
    return { uom1: hts['UOM1'] || '', uom2: hts['UOM2'] || '' };
  }

  function getSteelAlumPartNumber(tariff, type){
    if(!steelAlumDb || !steelAlumDb.length)
      return type === 'Steel' ? 'STEEL EXCL GENERIC' : 'ALUM GENERIC'; // UPDATED fallback

    const norm = normalizeTariffValue(tariff);
    const mapping = steelAlumDb.find(row => normalizeTariffValue(row['Tariff']) === norm);
    if(mapping) return type === 'Steel' ? mapping['Steel'] : mapping['Aluminum'];

    // UPDATED steel fallback name
    return type === 'Steel' ? 'STEEL EXCL GENERIC' : 'ALUM GENERIC';
  }

  function computeExportUnitPrice(item){
    const q = parseNum(item.quantity);
    const t = parseNum(item.line_total);
    if (isFinite(q) && q > 0 && isFinite(t)) {
      return (t / q).toFixed(6);
    }
    return '';
  }

  // ===== Descartes export =====
  function exportToDescartes(){
    if(!ALL.length){
      showAlert('No data to export', false);
      return;
    }

    const items = ALL.slice().sort((a,b)=>{
      const ai = String(a.invoice_number||''); const bi = String(b.invoice_number||'');
      if (ai !== bi) return ai.localeCompare(bi);
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn;
      return (A[2]||'').localeCompare(B[2]||'');
    });

    const roundWeight = (val) => {
      const num = parseNum(val);
      if (isNaN(num)) return '';
      if (num < 1 && num > 0) return 1;
      if (num <= 0) return '';
      return Math.round(num);
    };

    const currentUiSupplierByInvoice = {};
    try{
      const uiSupplier = UI.supplierInp?.value || '';
      const uiInvoice  = CURRENT || '';
      if(uiInvoice){ currentUiSupplierByInvoice[uiInvoice] = uiSupplier; }
    }catch(_){}
    items.forEach(rec=>{
      const inv = rec.invoice_number;
      if(!currentUiSupplierByInvoice[inv]) currentUiSupplierByInvoice[inv] = rec.supplier || '';
    });

    // Group by invoice + base position (numeric part)
    const groups = {};
    const orderedEntries = [];

    items.forEach(it=>{
      const pos = String(it.position||'');
      const m = pos.match(/^(\d+)([A-Z]?)$/);
      if(!m){
        orderedEntries.push({type:'single', item:it});
        return;
      }
      const baseNum = m[1];
      const suffix = (m[2]||'').toUpperCase();
      const key = `${it.invoice_number}|${baseNum}`;
      let g = groups[key];
      if(!g){
        g = groups[key] = {
          type:'group',
          invoice: it.invoice_number,
          baseNum,
          base:null,
          steels:[],
          alums:[],
          others:[]
        };
        orderedEntries.push(g);
      }
      if(!suffix){
        g.base = it;
      }else if(suffix === 'S'){
        g.steels.push(it);
      }else if(suffix === 'A'){
        g.alums.push(it);
      }else{
        g.others.push(it);
      }
    });

    const exportRows = [];

    function buildBaseRowSkeleton(item, buyerPartNum, supplierPartNum, itemTotalOverride){
      const supplierForInvoice = (currentUiSupplierByInvoice[item.invoice_number] || item.supplier || '');
      const effectiveItemTotal = (itemTotalOverride != null ? itemTotalOverride : item.line_total);

      const row = {
        'InvoiceNumber': item.invoice_number || '',
        'InvoiceDate': item.invoice_date || '',
        'InvoiceTotal': item.invoice_total || '',
        'SupplierMID': lookupSupplierMIDFromText(supplierForInvoice),
        'SupplierName': '',   // leave blank
        'BuyerPartNumber': buyerPartNum,
        'SupplierPartNumber': supplierPartNum,
        'Quantity': item.quantity || '',
        'UnitOfMeasure': item.unit || '',
        'Description': '',
        'UnitPrice': '',
        'ItemTotal': effectiveItemTotal || '',
        'CurrencyCode': 'USD',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin || '',
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': roundWeight(item.net_weight),
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': ''
      };

      row['UnitPrice'] = computeExportUnitPrice({quantity:item.quantity, line_total:effectiveItemTotal});
      return row;
    }

    function fillTariffsForBaseRow(row, partNumber, netWeightStr){
      const tariffs = lookupTariffsByPart(partNumber);
      const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];
      const netRounded = roundWeight(netWeightStr);
      const partUpper = String(partNumber).toUpperCase();

      tariffs.forEach((tariff, idx) => {
        if(idx < tariffFields.length){
          row[tariffFields[idx]] = tariff;
          const startsWithExempt = String(tariff).startsWith('98') || String(tariff).startsWith('99');
          if(!startsWithExempt){
            const uomInfo = lookupHtsUom(tariff);
            if(idx === 0){
              row['Quantity1'] = netRounded;
              row['UnitOfMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['Quantity2'] = netRounded;
                row['UnitOfMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 1){
              row['Secondary Quantity1'] = netRounded;
              row['Secondaryunitofmeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['secondaryquantity2'] = netRounded;
                row['secondaryunitofmeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 2){
              row['ThirdTariffQuantity1'] = netRounded;
              row['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['ThirdTariffQuantity2'] = netRounded;
                row['ThirdTariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 3){
              row['4TariffQuantity1'] = netRounded;
              row['4TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['4TariffQuantity2'] = netRounded;
                row['4TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 4){
              row['5TariffQuantity1'] = netRounded;
              row['5TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['5TariffQuantity2'] = netRounded;
                row['5TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            }
          }
        }
      });

      // STEEL EXCL base lines: ensure ThirdTariffQuantity1 uses NetWeight for 3rd tariff
      if(partUpper.startsWith('STEEL EXCL') && tariffs.length > 2 && tariffs[2]){
        row['ThirdTariffQuantity1'] = netRounded;
      }

      // ALL STEEL base parts:
      // - keep UOM behavior
      // - if 3rd tariff exists, ThirdTariffQuantity1 = NetWeight
      // - TariffNumber blank
      // - ThirdTariffUnitofMeasure1 blank
      // - NEW: Secondary Quantity1 = NetWeight
      if(partUpper.startsWith('ALL STEEL')){
        if(tariffs.length > 2 && tariffs[2]){
          row['ThirdTariffQuantity1'] = netRounded;
        }
        row['TariffNumber'] = '';
        row['ThirdTariffUnitofMeasure1'] = '';
        row['Secondary Quantity1'] = netRounded;
      }
    }

    function buildSteelOrAlumRow(item, type){
      const isSteel = (type === 'Steel');
      const parentPos = String(item.position||'').replace(/[SA]$/,'');
      const parentItem = items.find(it =>
        it.invoice_number === item.invoice_number &&
        String(it.position||'') === parentPos
      );

      let tariffForSubline = null;
      if(parentItem){
        const parentTariffs = lookupTariffsByPart(parentItem.part_number);
        tariffForSubline = parentTariffs.find(t => !String(t).startsWith('98') && !String(t).startsWith('99')) || null;
      }

      const subNum = tariffForSubline
        ? getSteelAlumPartNumber(tariffForSubline, isSteel ? 'Steel' : 'Aluminum')
        : (isSteel ? 'STEEL EXCL GENERIC' : 'ALUM GENERIC'); // fallback string

      const buyerPartNum = subNum;
      const supplierPartNum = subNum;
      const row = buildBaseRowSkeleton(item, buyerPartNum, supplierPartNum, item.line_total);

      const qtyRounded = roundWeight(item.quantity);

      if(isSteel){
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038191';
      }else{
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038508';
      }
      row['Secondary Quantity1'] = qtyRounded;
      row['Secondaryunitofmeasure1'] = 'KG';
      row['NetWeight'] = qtyRounded;

      // STEEL EXCL steel lines: use DB 3rd tariff and steel quantity
      const partUpper = String(subNum).toUpperCase();
      if (partUpper.startsWith('STEEL EXCL')) {
        const tariffs = lookupTariffsByPart(subNum);
        if (tariffs.length > 2 && tariffs[2]) {
          row['ThirdTariffNumber'] = tariffs[2];
          row['ThirdTariffQuantity1'] = qtyRounded;
        }
      }

      return row;
    }

    function processSingleItem(item){
      const pos = String(item.position||'');
      const isSteelLine = pos.endsWith('S');
      const isAlumLine  = pos.endsWith('A');

      if(isSteelLine){
        exportRows.push(buildSteelOrAlumRow(item,'Steel'));
        return;
      }
      if(isAlumLine){
        exportRows.push(buildSteelOrAlumRow(item,'Aluminum'));
        return;
      }

      const part = item.part_number || '';
      const buyerPartNum = part;
      const supplierPartNum = part;
      const row = buildBaseRowSkeleton(item, buyerPartNum, supplierPartNum, item.line_total);
      fillTariffsForBaseRow(row, part, item.net_weight);
      exportRows.push(row);
    }

    function processGroup(g){
      if(!g.base){
        g.steels.forEach(it=> processSingleItem(it));
        g.alums.forEach(it=> processSingleItem(it));
        g.others.forEach(it=> processSingleItem(it));
        return;
      }
      const base = g.base;
      const orig = parseNum(base._origLineTotal || base.line_total);
      let steelTotal = 0;
      g.steels.forEach(s=>{
        const v = parseNum(s.line_total);
        if(isFinite(v)) steelTotal += v;
      });

      const is100Steel =
        isFinite(orig) && orig>0 &&
        isFinite(steelTotal) && steelTotal>0 &&
        Math.abs(steelTotal - orig) <= orig * 0.01;

      if(is100Steel){
        const mainTariff = getMainTariffByPart(base.part_number);
        const allSteelPart = getAllSteelPartForTariff(mainTariff);
        const buyerPartNum = allSteelPart;
        const supplierPartNum = allSteelPart;
        const row = buildBaseRowSkeleton(base, buyerPartNum, supplierPartNum, fmt2(orig));
        fillTariffsForBaseRow(row, allSteelPart, base.net_weight);
        exportRows.push(row);
      }else{
        processSingleItem(base);
        g.steels.forEach(it=> exportRows.push(buildSteelOrAlumRow(it,'Steel')));
        g.alums.forEach(it=> exportRows.push(buildSteelOrAlumRow(it,'Aluminum')));
        g.others.forEach(it=> processSingleItem(it));
      }
    }

    orderedEntries.forEach(entry=>{
      if(entry.type === 'single'){
        processSingleItem(entry.item);
      }else{
        processGroup(entry);
      }
    });

    const headers = [
      'InvoiceNumber','InvoiceDate','InvoiceTotal','SupplierMID','SupplierName',
      'BuyerPartNumber','SupplierPartNumber','Quantity','UnitOfMeasure','Description',
      'UnitPrice','ItemTotal','CurrencyCode','ExchangeRate','CountryOfOrigin',
      'CountryOfExport','DateOfExport','PortOfLading','RelatedParty','PO_Number',
      'PO_Date','GrossWeight','GrossWeightUnit','NetWeight','TariffNumber',
      'TariffDescription','Quantity1','UnitOfMeasure1','Quantity2','UnitOfMeasure2',
      'Quantity3','UnitOfMeasure3','PrimarySPI','SecondarySPI','DeliverTo','SoldTo',
      'SellerMID','ShipperMID','EntryDate','ArrivalDate','Carrier','Vessel','Voyage',
      'PortOfEntry','PortOfUnloading','LocationCode','TotalCharges','BillOfLadingNumber',
      'Container','SecondaryTariffNumber','SecondaryTariffdescription','Secondary Quantity1',
      'Secondaryunitofmeasure1','secondaryquantity2','secondaryunitofmeasure2',
      'secondaryquantity3','secondaryunitofmeasure3','secondaryvalue','FTZStatus',
      'FTZPrivilegedDate\u00a0','ThirdTariffNumber','ThirdTariffDescription',
      'ThirdTariffQuantity1','ThirdTariffUnitofMeasure1','ThirdTariffQuantity2',
      'ThirdTariffUnitofMeasure2','ThirdTariffQuantity3','ThirdTariffUnitofMeasure3',
      'Third Value','4TariffNumber','4TariffDescription','4TariffQuantity1',
      '4TariffUnitofMeasure1','4TariffQuantity2','4TariffUnitofMeasure2',
      '4TariffQuantity3','4TariffUnitofMeasure3','4 Value',
      '5TariffNumber','5TariffDescription','5TariffQuantity1',
      '5TariffUnitofMeasure1','5TariffQuantity2','5TariffUnitofMeasure2',
      '5TariffQuantity3','5TariffUnitofMeasure3','5 Value'
    ];

    const aoa = [headers];
    exportRows.forEach(r=>{
      aoa.push(headers.map(h => (r[h] != null ? r[h] : '')));
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, 'DescartesUpload');

    const out  = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {
      type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href    = url;
    a.download = (filename? filename + '_' : '') + 'descartes_ci_upload.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
