<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grass Invoice PDF Parser â€” Descartes Export</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:1800px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{padding:28px 32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .header h1{font-size:22px;font-weight:800;margin-bottom:6px}
    .header p{opacity:.9}
    .upload{padding:28px}
    .drop{border:2px dashed #c7d2fe;border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:.2s}
    .drop:hover{background:#f8fafc}
    #fileInput{display:none}
    .loading{padding:28px;display:none;text-align:center}
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #6366f1;border-radius:50%;width:44px;height:44px;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{display:flex;gap:12px;align-items:center;padding:16px 20px;background:#f8fafc;border-top:1px solid #eef2ff;border-bottom:1px solid #eef2ff;flex-wrap:wrap}
    .bar select,.bar input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;min-width:280px}
    .bar button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer;margin-right:8px;margin-bottom:8px}
    .bar .ghost{background:#eef2ff;color:#111}
    .bar .success{background:#10b981;color:#fff}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px 20px;background:#fff}
    .stat{border:1px solid #eef2ff;border-radius:12px;padding:12px}
    .stat .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin-bottom:6px}
    .stat .val{font-size:18px;font-weight:800}
    .table{border-top:1px solid #eef2ff}
    .thead{background:#111;color:#fff;overflow:auto}
    .tbody{max-height:62vh;overflow:auto}
    .thead table,.tbody table{width:100%;table-layout:fixed;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-align:left}
    td input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:8px}
    .readonly{background:#f3f4f6}
    .actions{white-space:nowrap}
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
    .btn.del{background:#fee2e2}
    .btn.add{background:#dbeafe}
    .col-pos{width:64px}.col-part{width:260px}.col-qty{width:100px}.col-unit{width:72px}
    .col-price{width:120px}.col-total{width:130px}.col-weight{width:120px}.col-coo{width:80px}.col-hts{width:140px}.col-act{width:160px}
    .alert{display:none;margin:12px 20px;padding:10px 12px;border-radius:10px;border:1px solid}
    .alert.ok{display:block;background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .alert.err{display:block;background:#fef2f2;border-color:#fecaca;color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Grass Invoice PDF Parser (Descartes Export)</h1>
      <p>Steel content extraction with Descartes template export. Tab/Enter navigation enabled.</p>
    </div>

    <div class="upload" id="upload">
      <div class="drop" id="drop">
        <h3>ðŸ“¤ Click or Drag & Drop a PDF</h3>
        <p style="margin-top:6px;color:#6b7280">Optimized for Grass consolidated invoice format. Multiple invoices supported.</p>
        <input id="fileInput" type="file" accept="application/pdf,.pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Parsing PDF textâ€¦</strong></div>
    </div>

    <div class="alert" id="alert"></div>

    <div class="bar" id="bar" style="display:none">
      <select id="invoiceSel"><option value="">Select an invoiceâ€¦</option></select>
      <input id="supplierInp" placeholder="Supplier (edit)" />
      <input id="supplierMIDInp" placeholder="Supplier MID (e.g., 66666)" />
      <input id="dateInp" placeholder="Invoice Date MM/DD/YYYY" />
      <input id="totalInp" type="number" step="0.01" placeholder="Invoice Total (USD)" />
      <button id="exportBtn" class="success">Export to Descartes Template</button>
      <button id="exportSimpleBtn">Export Simple Excel</button>
      <button id="newBtn" class="ghost">New Upload</button>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="label">Invoice</div><div class="val" id="stInv">-</div></div>
      <div class="stat"><div class="label">Items</div><div class="val" id="stItems">0</div></div>
      <div class="stat"><div class="label">Invoice Total</div><div class="val" id="stTotal">$0.00</div></div>
      <div class="stat"><div class="label">Sum of Lines</div><div class="val" id="stSum">$0.00</div></div>
      <div class="stat"><div class="label">Difference</div><div class="val" id="stDiff">$0.00</div></div>
    </div>

    <div class="table" id="table" style="display:none">
      <div class="thead" id="thead">
        <table><thead><tr>
          <th class="col-pos">Pos</th>
          <th class="col-part">Part Number / Description</th>
          <th class="col-qty">Quantity</th>
          <th class="col-unit">Unit</th>
          <th class="col-price">Unit Price</th>
          <th class="col-total">Line Total</th>
          <th class="col-weight">Net Weight (kg)</th>
          <th class="col-coo">COO</th>
          <th class="col-hts">HTS Code</th>
          <th class="col-act">Actions</th>
        </tr></thead></table>
      </div>
      <div class="tbody" id="tbody">
        <table><tbody id="rows"></tbody></table>
      </div>
    </div>
  </div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const UI = {
    upload: $('#upload'), drop: $('#drop'), file: $('#fileInput'), loading: $('#loading'),
    alert: $('#alert'), bar: $('#bar'), invSel: $('#invoiceSel'),
    supplierInp: $('#supplierInp'), supplierMIDInp: $('#supplierMIDInp'),
    dateInp: $('#dateInp'), totalInp: $('#totalInp'),
    stats: $('#stats'), stInv: $('#stInv'), stItems: $('#stItems'),
    stTotal: $('#stTotal'), stSum: $('#stSum'), stDiff: $('#stDiff'),
    table: $('#table'), thead: $('#thead'), tbody: $('#tbody'),
    rows: $('#rows'), exportBtn: $('#exportBtn'), exportSimpleBtn: $('#exportSimpleBtn'), newBtn: $('#newBtn')
  };

  let ALL = [], ORDER = [], CURRENT = '', filename = '';

  function showAlert(msg, ok=true){ UI.alert.className = 'alert ' + (ok?'ok':'err'); UI.alert.textContent = msg; UI.alert.style.display='block'; setTimeout(()=> UI.alert.style.display='none', 3200); }
  function parseNum(s){
    if(s==null) return NaN; const t=String(s).trim(); if(!t) return NaN;
    if(/\d+[.,]\d{3}[.,]\d{2}$/.test(t)){ const last = t.lastIndexOf('.')>t.lastIndexOf(',')?'.':','; const intPart=t.slice(0,t.lastIndexOf(last)).replace(/[.,\s]/g,''); const dec=t.slice(t.lastIndexOf(last)+1); return parseFloat(intPart+'.'+dec); }
    if(/,\d{2}$/.test(t) && !/\.\d{2}$/.test(t)) return parseFloat(t.replace(/\./g,'').replace(',','.'));
    return parseFloat(t.replace(/,/g,''));
  }
  const fmt2 = n => (isFinite(+n)? (+n).toFixed(2):'');
  const toUS = d => { const m=String(d||'').match(/(\d{2})\.(\d{2})\.(\d{4})/); return m ? `${m[2]}/${m[1]}/${m[3]}` : (d||''); };
  const sumLines = list => list.reduce((a,r)=> a + (parseNum(r.line_total)||0), 0);
  const nextLetterPos = base => (String(base||'').replace(/[^0-9].*$/,'') || '0') + (Math.random()<0.5?'S':'A');

  UI.drop.addEventListener('click', ()=> UI.file.click());
  UI.file.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });
  UI.drop.addEventListener('dragover', e=>{ e.preventDefault(); UI.drop.style.background='#f1f5ff'; });
  UI.drop.addEventListener('dragleave', ()=> UI.drop.style.background='');
  UI.drop.addEventListener('drop', e=>{ e.preventDefault(); UI.drop.style.background=''; const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
  UI.newBtn.addEventListener('click', ()=> location.reload());

  async function handleFile(file){
    if(!/\.pdf$/i.test(file.name)){ showAlert('Please upload a PDF file', false); return; }
    filename = file.name.replace(/\.pdf$/i,'');
    UI.upload.style.display='none'; UI.loading.style.display='block';
    try{
      const buf = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let text = '';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const tc = await page.getTextContent({includeMarkedContent:true});
          text += (tc.items||[]).map(it=> it?.str || '').join(' ') + "\n";
        }catch(e){ console.warn('page read failed', i, e); }
      }
      if(!text.trim()){ showAlert('PDF has no extractable text (maybe scanned). Try OCR.', false); UI.upload.style.display='block'; return; }
      parseGrass(text);
      if(ALL.length){ buildUI(); showAlert(`Found ${new Set(ALL.map(x=>x.invoice_number)).size} invoice(s), ${ALL.length} row(s)`, true); }
      else { showAlert('No invoice rows were parsed. Try another file or adjust patterns.', false); UI.upload.style.display='block'; }
    }catch(err){ console.error(err); showAlert('Error: '+(err.message||String(err)), false); UI.upload.style.display='block'; }
    finally{ UI.loading.style.display='none'; }
  }

  function parseGrass(text){
    ALL.length = 0; ORDER.length = 0;
    const big = String(text||'');

    // Invoice meta
    const invm = [...big.matchAll(/Invoice\s+(\d{5,})/gi)];
    const invNum = invm.length? invm[0][1] : 'UNKNOWN';
    if(!ORDER.includes(invNum)) ORDER.push(invNum);

    let invDate = ''; const dm = big.match(/Date:\s*(\d{2}\.\d{2}\.\d{4})/); if(dm) invDate = toUS(dm[1]);

    // Supplier compact
    let supplier = 'GRASS GmbH';
    if(/\bGRASS\s+GmbH\s+(Ã–sterreich|Osterreich)\b/i.test(big)) supplier = 'GRASS GmbH Ã–sterreich';

    let invTotal = ''; const tm = big.match(/Total\s+Amount\s+([\d.,]+)\s+USD/i); if(tm) invTotal = String(parseNum(tm[1])||'');

    // Base items
    const itemRegex = /\b(F[0-9]{9,})\s+(\d+[\d.,]*)\s+(PCS|PC|SET|PAIRS?)\s+([\d.,]+)\s*\/\s*(\d+)\s+([\d.,]+)\s+USD/gi;
    const items = []; let m;
    while((m = itemRegex.exec(big)) !== null){
      items.push({ idx:m.index, part:m[1], qty:parseNum(m[2]), unit:m[3].toUpperCase(), unitPricePer:parseNum(m[4]), perDivisor:parseNum(m[5]), lineTotal:parseNum(m[6]) });
    }

    if(!items.length){
      ALL.push({invoice_number:invNum, invoice_date:invDate, supplier, invoice_total:invTotal, position:'', part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:'', country_of_origin:'', hts_code:''});
      return;
    }

    items.forEach((it, i)=>{
      // Fence slab by next item (extended window)
      const start = it.idx;
      const end = (i < items.length-1 ? items[i+1].idx : start + 15000);
      const slab = big.slice(start, end);

      // COO & net weight
      let coo = ''; const cooM = slab.match(/Country\s+of\s+Origin:\s*([A-Z]{2})/i); if(cooM) coo = cooM[1].toUpperCase();
      let netkg = ''; const wM = slab.match(/Net\s+weight\s+in\s+kg:\s*([\d.,]+)/i); if(wM) netkg = fmt2(parseNum(wM[1]));
      
      // HTS/Tariff code
      let htsCode = ''; const htsM = slab.match(/Customs\s+tariff\s+nr:\s*([\d\s]+)/i); 
      if(htsM) htsCode = htsM[1].replace(/\s/g,'');

      // Anchor region by this exact part
      const escPart = it.part.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const partAnchor = new RegExp('\\b' + escPart + '\\b', 'i');
      const partIdx = slab.search(partAnchor);
      const regionStart = partIdx >= 0 ? partIdx : 0;
      const afterPart = slab.slice(regionStart);

      // Extended search window for steel/aluminum data
      const nextPartRel = afterPart.slice(10).search(/\bF[0-9]{9,}\b/);
      const fenceEndRel = nextPartRel > -1 ? (10 + nextPartRel) : Math.min(afterPart.length, 12000);
      const region = afterPart.slice(0, fenceEndRel);

      // === LAST-match logic with enhanced patterns ===
      let steelKG=NaN, steelVal=NaN;

      // Try multiple patterns for steel data
      const steelPatterns = [
        /Net\s*weight\s*in\s*kg\s*in\s*steel\s*[:\s]+([\d.,]+)/gi,
        /steel\s*[:\s]+([\d.,]+)\s*kg/gi
      ];
      const steelValuePatterns = [
        /Steel\s*value\s*[:\s]+([\d.,]+)/gi,
        /steel\s*[:\s]+USD?\s*([\d.,]+)/gi,
        /steel[:\s]+([\d.,]+)/gi
      ];

      // Search for steel weight
      for(let pattern of steelPatterns){
        const matches = [...region.matchAll(pattern)];
        if(matches.length){
          steelKG = parseNum(matches[matches.length-1][1]);
          break;
        }
      }

      // Search for steel value
      for(let pattern of steelValuePatterns){
        const matches = [...region.matchAll(pattern)];
        if(matches.length){
          const val = parseNum(matches[matches.length-1][1]);
          if(isFinite(val) && val > 0){
            steelVal = val;
            break;
          }
        }
      }

      // Fallback: widen search if still missing
      if(!isFinite(steelVal)){
        const wideSearch = slab;
        for(let pattern of steelValuePatterns){
          const matches = [...wideSearch.matchAll(pattern)];
          if(matches.length){
            const val = parseNum(matches[matches.length-1][1]);
            if(isFinite(val) && val > 0){
              steelVal = val;
              break;
            }
          }
        }
      }

      console.log('PART', it.part, 'steelKG=', steelKG, 'steelVal=', steelVal, 'regionLen=', region.length);

      // Unit price in selling unit
      const unitPrice = (isFinite(it.unitPricePer) && isFinite(it.perDivisor) && it.perDivisor>0) ? (it.unitPricePer / it.perDivisor) : '';

      const pos = (i+1).toString();

      // Adjust main line by steel subvalue ONLY
      let baseTotal = it.lineTotal;
      const subSteel = isFinite(steelVal)? steelVal : 0;
      if(isFinite(baseTotal)) baseTotal = Math.max(0, baseTotal - subSteel);

      // Base line
      ALL.push({
        invoice_number: invNum, invoice_date: invDate, supplier, invoice_total: invTotal,
        position: pos, part_number: it.part,
        quantity: isFinite(it.qty)? fmt2(it.qty) : '', unit: it.unit,
        unit_price: isFinite(unitPrice) ? fmt2(unitPrice) : '',
        line_total: isFinite(baseTotal) ? fmt2(baseTotal) : '',
        net_weight: netkg, country_of_origin: coo, hts_code: htsCode
      });

      // Steel subline (only if we have a valid steel value)
      if(isFinite(subSteel) && subSteel>0){
        ALL.push({
          invoice_number: invNum, invoice_date: invDate, supplier, invoice_total: invTotal,
          position: pos + 'S', part_number: 'Steel - ' + it.part,
          quantity: isFinite(steelKG)? fmt2(steelKG):'', unit:'KG', unit_price:'',
          line_total: fmt2(subSteel), net_weight:'', country_of_origin: coo, hts_code: '99030133'
        });
      }
    });
  }

  function buildUI(){
    UI.bar.style.display='flex';
    const header = UI.thead, body = UI.tbody; let sync=false;
    body.addEventListener('scroll',()=>{ if(sync) return; sync=true; header.scrollLeft = body.scrollLeft; sync=false; });

    UI.invSel.innerHTML = '<option value="">Select an invoiceâ€¦</option>';
    const meta = {};
    ALL.forEach(r=>{ if(!meta[r.invoice_number]) meta[r.invoice_number] = {date:r.invoice_date,supplier:r.supplier,total:r.invoice_total,count:0}; meta[r.invoice_number].count++; });
    ORDER.forEach(id=>{
      const m = meta[id]||{date:'',supplier:'',total:'',count:0};
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = `Invoice ${id} â€” ${m.count} items â€” ${m.date} â€” ${m.supplier} â€” $${Number(m.total||0).toFixed(2)}`;
      UI.invSel.appendChild(opt);
    });

    UI.invSel.onchange = ()=>{ CURRENT = UI.invSel.value; if(CURRENT){ renderInvoice(CURRENT); } };
    UI.exportBtn.onclick = exportToDescartes;
    UI.exportSimpleBtn.onclick = exportSimpleExcel;

    CURRENT = ORDER[0]; UI.invSel.value = CURRENT; renderInvoice(CURRENT);

    UI.invSel.tabIndex = 1; UI.supplierInp.tabIndex = 2; UI.supplierMIDInp.tabIndex = 3; UI.dateInp.tabIndex = 4; UI.totalInp.tabIndex = 5;
  }

  function renderInvoice(id){
    const rows = ALL.filter(r=>r.invoice_number===id).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });

    const meta = rows[0]||{};
    UI.supplierInp.value = meta.supplier||'';
    UI.dateInp.value = meta.invoice_date||'';
    UI.totalInp.value = meta.invoice_total||'';

    UI.stInv.textContent = id;
    UI.stItems.textContent = String(rows.length);
    UI.stTotal.textContent = '$'+Number(meta.invoice_total||0).toFixed(2);

    UI.rows.innerHTML = '';
    rows.forEach((r, idx)=>{ UI.rows.appendChild(renderRow(r, idx)); });

    UI.table.style.display='block'; UI.stats.style.display='grid';
    recomputeStats();

    UI.supplierInp.onchange = e=> updateHdr('supplier', e.target.value);
    UI.dateInp.onchange = e=> updateHdr('invoice_date', e.target.value);
    UI.totalInp.onchange = e=> { updateHdr('invoice_total', e.target.value); recomputeStats(); };

    rebuildTabOrder();
  }

  function renderRow(row, idx){
    const tr = document.createElement('tr');
    function cell(val, key, ro=false){
      const td=document.createElement('td'); const inp=document.createElement('input');
      inp.value = val==null? '' : String(val); 
      if(ro){ inp.className='readonly'; inp.readOnly=true; }
      inp.onchange = ()=> updateCell(idx, key, inp.value);
      // Tab and Enter navigation
      inp.onkeydown = ev=>{
        if(ev.key==='Enter' || ev.key==='Tab'){
          ev.preventDefault();
          focusNext(inp, (ev.shiftKey || (ev.key==='Tab' && ev.shiftKey))?-1:1);
        }
      };
      td.appendChild(inp); return td;
    }
    const actions = document.createElement('td'); actions.className='actions';
    const add = document.createElement('button'); add.className='btn add'; add.textContent='âž•'; add.onclick=()=> addBelow(idx);
    const del = document.createElement('button'); del.className='btn del'; del.textContent='ðŸ—‘ï¸'; del.onclick=()=> removeRow(idx);
    actions.appendChild(add); actions.appendChild(del);

    tr.appendChild(cell(row.position,'position'));
    tr.appendChild(cell(row.part_number,'part_number'));
    tr.appendChild(cell(row.quantity,'quantity'));
    tr.appendChild(cell(row.unit,'unit'));
    tr.appendChild(cell(row.unit_price,'unit_price'));
    tr.appendChild(cell(row.line_total,'line_total'));
    tr.appendChild(cell(row.net_weight,'net_weight'));
    tr.appendChild(cell(row.country_of_origin,'country_of_origin'));
    tr.appendChild(cell(row.hts_code,'hts_code'));
    tr.appendChild(actions);
    return tr;
  }

  function rebuildTabOrder(){ let ti = 10; $$('#rows input').forEach(inp=>{ inp.tabIndex = ti++; }); }
  
  function focusNext(current, dir){
    const inputs = [UI.invSel, UI.supplierInp, UI.supplierMIDInp, UI.dateInp, UI.totalInp, ...$$('#rows input')].filter(Boolean);
    const idx = inputs.indexOf(current);
    const nextIdx = Math.max(0, Math.min(inputs.length-1, idx + (dir||1)));
    const target = inputs[nextIdx]; if(target){ target.focus(); target.select?.(); }
  }

  function updateCell(viewIdx, key, val){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const target = rows[viewIdx]; const idx = ALL.indexOf(target);
    if(idx>=0){ 
      const oldVal = ALL[idx][key];
      ALL[idx][key]=val; 
      
      // If updating line_total on a steel/aluminum line, adjust parent
      if(key === 'line_total' && isSubline(ALL[idx])){
        adjustParentTotal(ALL[idx], oldVal, val);
      }
      
      renderInvoice(CURRENT); 
    }
  }

  function isSubline(row){
    const pos = String(row.position||'');
    return /[A-Z]$/.test(pos) || /^(Steel|Aluminum|Other)\s*-\s*/i.test(row.part_number||'');
  }

  function getParentPosition(pos){
    return String(pos||'').replace(/[A-Z]$/,'');
  }

  function adjustParentTotal(subline, oldTotal, newTotal){
    const parentPos = getParentPosition(subline.position);
    const parent = ALL.find(r=> r.invoice_number===CURRENT && r.position===parentPos);
    if(parent){
      const oldNum = parseNum(oldTotal)||0;
      const newNum = parseNum(newTotal)||0;
      const delta = newNum - oldNum;
      const currentParentTotal = parseNum(parent.line_total)||0;
      parent.line_total = fmt2(Math.max(0, currentParentTotal - delta));
    }
  }

  function addBelow(viewIdx){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const base = rows[viewIdx];
    const insert = { 
      invoice_number: CURRENT, invoice_date: base.invoice_date, supplier: base.supplier, 
      invoice_total: base.invoice_total, position: nextLetterPos(base.position), 
      part_number:'', quantity:'', unit:'', unit_price:'', line_total:'0.00', 
      net_weight:'', country_of_origin: base.country_of_origin, hts_code:''
    };
    const idx = ALL.indexOf(base);
    ALL.splice(idx+1, 0, insert);
    renderInvoice(CURRENT);
  }

  function removeRow(viewIdx){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const target = rows[viewIdx];
    
    // If deleting a steel/aluminum subline, add its total back to parent
    if(isSubline(target)){
      const parentPos = getParentPosition(target.position);
      const parent = ALL.find(r=> r.invoice_number===CURRENT && r.position===parentPos);
      if(parent){
        const subTotal = parseNum(target.line_total)||0;
        const currentParentTotal = parseNum(parent.line_total)||0;
        parent.line_total = fmt2(currentParentTotal + subTotal);
      }
    }
    
    const idx = ALL.indexOf(target);
    if(idx>=0){ ALL.splice(idx,1); renderInvoice(CURRENT); }
  }

  function updateHdr(field, val){ ALL.forEach(r=>{ if(r.invoice_number===CURRENT){ r[field]=val; }}); }

  function recomputeStats(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT);
    const invTotal = parseNum(rows[0]?.invoice_total);
    const sum = sumLines(rows);
    UI.stTotal.textContent = '$'+(isFinite(invTotal)?invTotal.toFixed(2):'0.00');
    UI.stSum.textContent = '$'+sum.toFixed(2);
    const diff = (isFinite(invTotal)?invTotal:0) - sum;
    UI.stDiff.textContent = '$'+diff.toFixed(2);
  }

  function roundWeight(val){
    const num = parseFloat(val);
    if(isNaN(num)) return '';
    if(num < 1) return 1;
    return Math.round(num);
  }

  function exportToDescartes(){
    if(!ALL.length){ showAlert('No data to export', false); return; }

    const items = ALL.slice().sort((a,b)=>{
      const ai = String(a.invoice_number||''); const bi = String(b.invoice_number||'');
      if (ai !== bi) return ai.localeCompare(bi);
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });

    const supplierMID = UI.supplierMIDInp.value || '66666'; // Default or from input
    const exportRows = [];

    items.forEach(item => {
      const isSteelLine = String(item.position||'').endsWith('S') || /^Steel\s*-/i.test(item.part_number||'');
      const isAlumLine = String(item.position||'').endsWith('A') || /^Aluminum\s*-/i.test(item.part_number||'');

      let buyerPartNum, supplierPartNum;
      if (!isSteelLine && !isAlumLine) {
        buyerPartNum = item.part_number || '';
        supplierPartNum = item.part_number || '';
      } else {
        // For steel/aluminum lines, use generic part numbers
        const subNum = isSteelLine ? 'STEEL GENERIC' : 'ALUM GENERIC';
        buyerPartNum = subNum;
        supplierPartNum = subNum;
      }

      const row = {
        'InvoiceNumber': item.invoice_number,
        'InvoiceDate': item.invoice_date,
        'InvoiceTotal': item.invoice_total,
        'SupplierMID': supplierMID,
        'SupplierName': item.supplier,
        'BuyerPartNumber': buyerPartNum,
        'SupplierPartNumber': supplierPartNum,
        'Quantity': item.quantity,
        'UnitOfMeasure': item.unit,
        'Description': '',
        'UnitPrice': item.unit_price,
        'ItemTotal': item.line_total,
        'CurrencyCode': 'USD',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin,
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': roundWeight(item.net_weight),
        'TariffNumber': item.hts_code || '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': '',
        '6TariffNumber': '',
        '6TariffDescription': '',
        '6TariffQuantity1': '',
        '6TariffUnitofMeasure1': '',
        '6TariffQuantity2': '',
        '6TariffUnitofMeasure2': '',
        '6TariffQuantity3': '',
        '6TariffUnitofMeasure3': '',
        '6 Value': '',
        '7TariffNumber': '',
        '7TariffDescription': '',
        '7TariffQuantity1': '',
        '7TariffUnitofMeasure1': '',
        '7TariffQuantity2': '',
        '7TariffUnitofMeasure2': '',
        '7TariffQuantity3': '',
        '7TariffUnitofMeasure3': '',
        '7 Value': '',
        '8TariffNumber': '',
        '8TariffDescription': '',
        '8TariffQuantity1': '',
        '8TariffUnitofMeasure1': '',
        '8TariffQuantity2': '',
        '8TariffUnitofMeasure2': '',
        '8TariffQuantity3': '',
        '8TariffUnitofMeasure3': '',
        '8 Value': ''
      };

      // Special handling for steel/aluminum lines
      if (isSteelLine) {
        row['NetWeight'] = roundWeight(item.quantity);
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038191';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      if (isAlumLine) {
        row['NetWeight'] = roundWeight(item.quantity);
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038508';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      // For main lines with HTS codes, populate quantity fields
      if (!isSteelLine && !isAlumLine && item.hts_code) {
        row['Quantity1'] = roundWeight(item.net_weight);
        row['UnitOfMeasure1'] = 'KG';
      }

      exportRows.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportRows);
    XLSX.utils.book_append_sheet(wb, ws, 'Descartes Export');

    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (filename?filename+'_':'')+'descartes_export.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('Descartes template exported successfully!', true);
  }

  function exportSimpleExcel(){
    const wb = XLSX.utils.book_new();
    const byInv = {};
    ALL.forEach(r=>{ if(!byInv[r.invoice_number]) byInv[r.invoice_number] = []; byInv[r.invoice_number].push(r); });
    Object.keys(byInv).forEach(id=>{
      const rows = byInv[id].slice().sort((a,b)=>{
        const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
        const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
        const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
        if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
      });
      const head = [
        ['Invoice', id],
        ['Date', rows[0]?.invoice_date||''],
        ['Supplier', rows[0]?.supplier||''],
        ['Invoice Total', rows[0]?.invoice_total||''],
        [],
        ['Pos','Part Number','Quantity','Unit','Unit Price','Line Total','Net Weight (kg)','COO','HTS Code']
      ];
      const body = rows.map(r=>[
        r.position||'', r.part_number||'', r.quantity||'', r.unit||'', r.unit_price||'', r.line_total||'', r.net_weight||'', r.country_of_origin||'', r.hts_code||''
      ]);
      const ws = XLSX.utils.aoa_to_sheet([...head, ...body]);
      XLSX.utils.book_append_sheet(wb, ws, ('INV_'+id).slice(0,31));
    });
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = (filename? filename + '_' : '') + 'grass_simple.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showAlert('Simple Excel exported successfully!', true);
  }
</script>
</body>
</html>
