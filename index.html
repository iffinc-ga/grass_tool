<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grass Invoice PDF Parser ‚Äî Steel/Other Sublines</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:1800px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{padding:28px 32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .header h1{font-size:22px;font-weight:800;margin-bottom:6px}
    .header p{opacity:.9}

    .upload{padding:28px}
    .drop{border:2px dashed #c7d2fe;border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:.2s}
    .drop:hover{background:#f8fafc}
    #fileInput{display:none}

    .loading{padding:28px;display:none;text-align:center}
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #6366f1;border-radius:50%;width:44px;height:44px;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bar{display:flex;gap:12px;align-items:center;padding:16px 20px;background:#f8fafc;border-top:1px solid #eef2ff;border-bottom:1px solid #eef2ff}
    .bar select,.bar input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;min-width:320px}
    .bar button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    .bar .ghost{background:#eef2ff;color:#111}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px 20px;background:#fff}
    .stat{border:1px solid #eef2ff;border-radius:12px;padding:12px}
    .stat .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin-bottom:6px}
    .stat .val{font-size:18px;font-weight:800}
    .stat input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px;font-weight:700}

    .table{border-top:1px solid #eef2ff}
    .thead{background:#111;color:#fff;overflow:auto}
    .tbody{max-height:62vh;overflow:auto}
    .thead table,.tbody table{width:100%;table-layout:fixed;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-align:left}
    td input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:8px}
    .readonly{background:#f3f4f6}
    .actions{white-space:nowrap}
    .btn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
    .btn.del{background:#fee2e2}
    .btn.add{background:#dbeafe}

    .col-pos{width:64px}
    .col-part{width:260px}
    .col-qty{width:100px}
    .col-unit{width:72px}
    .col-price{width:120px}
    .col-total{width:130px}
    .col-weight{width:120px}
    .col-coo{width:80px}
    .col-act{width:160px}

    .alert{display:none;margin:12px 20px;padding:10px 12px;border-radius:10px;border:1px solid}
    .alert.ok{display:block;background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .alert.err{display:block;background:#fef2f2;border-color:#fecaca;color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Grass Invoice PDF Parser (Steel/Other sublines)</h1>
      <p>Drop in a Grass consolidated invoice PDF. The tool extracts lines, subtracts Steel/Other allocations from the main line, and inserts S/A sublines directly below the base line.</p>
    </div>

    <div class="upload" id="upload">
      <div class="drop" id="drop">
        <h3>üì§ Click or Drag & Drop a PDF</h3>
        <p style="margin-top:6px;color:#6b7280">Optimized for Grass format (e.g., ‚ÄúInvoice ‚Ä¶‚Äù, ‚ÄúNet weight in kg in steel/other‚Äù, DE/CZ COO).</p>
        <input id="fileInput" type="file" accept="application/pdf,.pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Parsing PDF text‚Ä¶</strong></div>
    </div>

    <div class="alert" id="alert"></div>

    <div class="bar" id="bar" style="display:none">
      <select id="invoiceSel"><option value="">Select an invoice‚Ä¶</option></select>
      <input id="supplierInp" placeholder="Supplier (edit)" />
      <input id="dateInp" placeholder="Invoice Date MM/DD/YYYY" />
      <input id="totalInp" type="number" step="0.01" placeholder="Invoice Total (USD)" />
      <button id="exportBtn">Export to Excel</button>
      <button id="newBtn" class="ghost">New Upload</button>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="label">Invoice</div><div class="val" id="stInv">-</div></div>
      <div class="stat"><div class="label">Items</div><div class="val" id="stItems">0</div></div>
      <div class="stat"><div class="label">Invoice Total</div><div class="val" id="stTotal">$0.00</div></div>
      <div class="stat"><div class="label">Sum of Lines</div><div class="val" id="stSum">$0.00</div></div>
      <div class="stat"><div class="label">Difference</div><div class="val" id="stDiff">$0.00</div></div>
    </div>

    <div class="table" id="table" style="display:none">
      <div class="thead" id="thead">
        <table><thead><tr>
          <th class="col-pos">Pos</th>
          <th class="col-part">Part Number / Description</th>
          <th class="col-qty">Quantity</th>
          <th class="col-unit">Unit</th>
          <th class="col-price">Unit Price</th>
          <th class="col-total">Line Total</th>
          <th class="col-weight">Net Weight (kg)</th>
          <th class="col-coo">COO</th>
          <th class="col-act">Actions</th>
        </tr></thead></table>
      </div>
      <div class="tbody" id="tbody">
        <table><tbody id="rows"></tbody></table>
      </div>
    </div>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const UI = {
    upload: $('#upload'),
    drop: $('#drop'),
    file: $('#fileInput'),
    loading: $('#loading'),
    alert: $('#alert'),
    bar: $('#bar'),
    invSel: $('#invoiceSel'),
    supplierInp: $('#supplierInp'),
    dateInp: $('#dateInp'),
    totalInp: $('#totalInp'),
    stats: $('#stats'),
    stInv: $('#stInv'),
    stItems: $('#stItems'),
    stTotal: $('#stTotal'),
    stSum: $('#stSum'),
    stDiff: $('#stDiff'),
    table: $('#table'),
    thead: $('#thead'),
    tbody: $('#tbody'),
    rows: $('#rows'),
    exportBtn: $('#exportBtn'),
    newBtn: $('#newBtn'),
  };

  let ALL = []; // parsed rows
  let ORDER = []; // invoice numbers
  let CURRENT = '';
  let filename = '';

  function showAlert(msg, ok=true){
    UI.alert.className = 'alert ' + (ok?'ok':'err');
    UI.alert.textContent = msg; UI.alert.style.display='block';
    setTimeout(()=> UI.alert.style.display='none', 3200);
  }

  function parseNum(s){
    if(s==null) return NaN;
    const t = String(s).trim();
    if(!t) return NaN;
    if(/\d+[.,]\d{3}[.,]\d{2}$/.test(t)){
      const last = t.lastIndexOf('.')>t.lastIndexOf(',')?'.':',';
      const intPart = t.slice(0, t.lastIndexOf(last)).replace(/[.,\s]/g,'');
      const decPart = t.slice(t.lastIndexOf(last)+1);
      return parseFloat(intPart + '.' + decPart);
    }
    if(/,\d{2}$/.test(t) && !/\.\d{2}$/.test(t)){
      return parseFloat(t.replace(/\./g,'').replace(',','.'));
    }
    return parseFloat(t.replace(/,/g,''));
  }
  function fmt2(n){ const x = Number(n); return isFinite(x)? x.toFixed(2):''; }
  function toUS(ddmmyyyy){
    const m = String(ddmmyyyy||'').match(/(\d{2})\.(\d{2})\.(\d{4})/);
    return m ? `${m[2]}/${m[1]}/${m[3]}` : (ddmmyyyy||'');
  }
  function sumLines(list){ return list.reduce((a,r)=> a + (parseNum(r.line_total)||0), 0); }
  function nextLetterPos(base){ const num = String(base||'').replace(/[^0-9].*$/,'') || '0'; return num + (Math.random()<0.5?'S':'A'); }

  UI.drop.addEventListener('click', ()=> UI.file.click());
  UI.file.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });
  UI.drop.addEventListener('dragover', e=>{ e.preventDefault(); UI.drop.style.background='#f1f5ff'; });
  UI.drop.addEventListener('dragleave', ()=> UI.drop.style.background='');
  UI.drop.addEventListener('drop', e=>{ e.preventDefault(); UI.drop.style.background=''; const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
  UI.newBtn.addEventListener('click', ()=> location.reload());

  async function handleFile(file){
    if(!/\.pdf$/i.test(file.name)){ showAlert('Please upload a PDF file', false); return; }
    filename = file.name.replace(/\.pdf$/i,'');
    UI.upload.style.display='none'; UI.loading.style.display='block';
    try{
      const buf = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let text = '';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const tc = await page.getTextContent({includeMarkedContent:true});
          text += (tc.items||[]).map(it=> it?.str || '').join(' ') + "\n";
        }catch(e){ console.warn('page read failed', i, e); }
      }
      if(!text.trim()){ showAlert('PDF has no selectable text (maybe scanned). Try OCR.', false); UI.upload.style.display='block'; return; }
      parseGrass(text);
      if(ALL.length){
        buildUI();
        showAlert(`Found ${new Set(ALL.map(x=>x.invoice_number)).size} invoice(s), ${ALL.length} row(s)`, true);
      }else{
        showAlert('No invoice rows were parsed. Try another file or adjust patterns.', false);
        UI.upload.style.display='block';
      }
    }catch(err){ console.error(err); showAlert('Error: '+(err.message||String(err)), false); UI.upload.style.display='block'; }
    finally{ UI.loading.style.display='none'; }
  }

  // --------- Parser ----------
  function parseGrass(text){
    ALL.length = 0; ORDER.length = 0;
    const big = String(text||'');

    // Invoice number
    const invMatch = [...big.matchAll(/Invoice\s+(\d{5,})/gi)];
    const invNum = invMatch.length ? invMatch[0][1] : 'UNKNOWN';
    if(!ORDER.includes(invNum)) ORDER.push(invNum);

    // Date
    let invDate = '';
    const dm = big.match(/Date:\s*(\d{2}\.\d{2}\.\d{4})/); if(dm) invDate = toUS(dm[1]);

    // Supplier (compact)
    let supplier = 'GRASS GmbH';
    const supExact = big.match(/\bGRASS\s+GmbH\s+(√ñsterreich|Osterreich)\b/i);
    if(supExact){ supplier = 'GRASS GmbH √ñsterreich'; }
    else if(/\bGRASS\s+GmbH\b/i.test(big)) { supplier = 'GRASS GmbH'; }

    // Invoice total
    let invTotal = '';
    const tm = big.match(/Total\s+Amount\s+([\d.,]+)\s+USD/i);
    if(tm) invTotal = String(parseNum(tm[1])||'');

    // Line header
    const itemRegex = /\b(F\d{9,})\s+(\d+[\d.,]*)\s+(PCS|PC|SET|PAIRS?)\s+([\d.,]+)\s*\/\s*(\d+)\s+([\d.,]+)\s+USD/gi;
    const items = [];
    let m;
    while((m = itemRegex.exec(big)) !== null){
      items.push({ idx: m.index, part: m[1], qty: parseNum(m[2]), unit: m[3].toUpperCase(), unitPricePer: parseNum(m[4]), perDivisor: parseNum(m[5]), lineTotal: parseNum(m[6]) });
    }

    if(items.length===0){
      ALL.push({invoice_number:invNum, invoice_date:invDate, supplier, invoice_total:invTotal, position:'', part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:'', country_of_origin:''});
      return;
    }

    items.forEach((it, i)=>{
      const start = it.idx;
      const end = (i < items.length-1 ? items[i+1].idx : start + 2000);
      let slab = big.slice(start, end);

      // COO
      let coo = '';
      const cooM = slab.match(/Country\s+of\s+Origin:\s*([A-Z]{2})/i); if(cooM) coo = cooM[1].toUpperCase();

      // Net weight
      let netkg = '';
      const wM = slab.match(/Net\s+weight\s+in\s+kg:\s*([\d.,]+)/i); if(wM) netkg = fmt2(parseNum(wM[1]));

      // Scope steel/other region right after ‚ÄúNet weight in kg:‚Äù
      let steelKG=NaN, steelVal=NaN, otherKG=NaN, otherVal=NaN;
      const netIdx = slab.search(/Net\s+weight\s+in\s+kg:/i);
      const regionStart = netIdx >= 0 ? netIdx : 0;
      const regionEnd = Math.min(regionStart + 600, slab.length); // widen if needed
      const region = slab.slice(regionStart, regionEnd);

      const sKGm = region.match(/Net\s+weight\s+in\s+kg\s+in\s+steel:\s*([\d.,]+)/i);
      const sVm  = region.match(/Steel\s+value:\s*([\d.,]+)/i);
      const oKGm = region.match(/Net\s+weight\s+in\s+kg\s+in\s+other:\s*([\d.,]+)/i);
      const oVm  = region.match(/Other\s+value:\s*([\d.,]+)/i);
      if(sKGm) steelKG = parseNum(sKGm[1]);
      if(sVm)  steelVal = parseNum(sVm[1]);
      if(oKGm) otherKG  = parseNum(oKGm[1]);
      if(oVm)  otherVal = parseNum(oVm[1]);

      // Compute USD per selling unit
      const unitPrice = (isFinite(it.unitPricePer) && isFinite(it.perDivisor) && it.perDivisor>0)
        ? (it.unitPricePer / it.perDivisor)
        : '';

      // Position
      const pos = (i+1).toString();

      // Subtract steel/other from main line
      let baseTotal = it.lineTotal;
      const subSteel = isFinite(steelVal)? steelVal : 0;
      const subOther = isFinite(otherVal)? otherVal : 0;
      if(isFinite(baseTotal)) baseTotal = Math.max(0, baseTotal - subSteel - subOther);

      // Base row
      ALL.push({
        invoice_number: invNum,
        invoice_date: invDate,
        supplier,
        invoice_total: invTotal,
        position: pos,
        part_number: it.part,
        quantity: isFinite(it.qty)? fmt2(it.qty) : '',
        unit: it.unit,
        unit_price: isFinite(unitPrice) ? fmt2(unitPrice) : '',
        line_total: isFinite(baseTotal) ? fmt2(baseTotal) : '',
        net_weight: netkg,
        country_of_origin: coo
      });

      // Steel subline (S)
      if(isFinite(subSteel) && subSteel>0){
        ALL.push({
          invoice_number: invNum,
          invoice_date: invDate,
          supplier,
          invoice_total: invTotal,
          position: pos + 'S',
          part_number: 'Steel - ' + it.part,
          quantity: isFinite(steelKG)? fmt2(steelKG):'',
          unit: 'KG',
          unit_price: '',
          line_total: fmt2(subSteel),
          net_weight: '',
          country_of_origin: coo
        });
      }
      // Other subline (A)
      if(isFinite(subOther) && subOther>0){
        ALL.push({
          invoice_number: invNum,
          invoice_date: invDate,
          supplier,
          invoice_total: invTotal,
          position: pos + 'A',
          part_number: 'Other - ' + it.part,
          quantity: isFinite(otherKG)? fmt2(otherKG):'',
          unit: 'KG',
          unit_price: '',
          line_total: fmt2(subOther),
          net_weight: '',
          country_of_origin: coo
        });
      }
    });
  }

  // --------- UI ----------
  function buildUI(){
    UI.bar.style.display='flex';

    // sync header scroll
    const header = UI.thead; const body = UI.tbody; let sync=false;
    body.addEventListener('scroll',()=>{ if(sync) return; sync=true; header.scrollLeft = body.scrollLeft; sync=false; });

    // Invoices dropdown
    UI.invSel.innerHTML = '<option value="">Select an invoice‚Ä¶</option>';
    const meta = {};
    ALL.forEach(r=>{ if(!meta[r.invoice_number]) meta[r.invoice_number] = {date:r.invoice_date,supplier:r.supplier,total:r.invoice_total,count:0}; meta[r.invoice_number].count++; });
    ORDER.forEach(id=>{
      const m = meta[id]||{date:'',supplier:'',total:'',count:0};
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = `Invoice ${id} ‚Äî ${m.count} items ‚Äî ${m.date} ‚Äî ${m.supplier} ‚Äî $${Number(m.total||0).toFixed(2)}`;
      UI.invSel.appendChild(opt);
    });

    UI.invSel.onchange = ()=>{ CURRENT = UI.invSel.value; if(CURRENT){ renderInvoice(CURRENT); } };
    UI.exportBtn.onclick = exportExcel;

    // Auto-load first invoice
    CURRENT = ORDER[0]; UI.invSel.value = CURRENT; renderInvoice(CURRENT);

    // Header input tab order
    UI.invSel.tabIndex = 1;
    UI.supplierInp.tabIndex = 2;
    UI.dateInp.tabIndex = 3;
    UI.totalInp.tabIndex = 4;
  }

  function renderInvoice(id){
    const rows = ALL.filter(r=>r.invoice_number===id).slice();
    rows.sort((a,b)=>{
      const A = (String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B = (String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an = parseInt(A[1]||999999,10), bn = parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });

    const meta = rows[0]||{};
    UI.supplierInp.value = meta.supplier||'';
    UI.dateInp.value = meta.invoice_date||'';
    UI.totalInp.value = meta.invoice_total||'';

    UI.stInv.textContent = id;
    UI.stItems.textContent = String(rows.length);
    UI.stTotal.textContent = '$'+Number(meta.invoice_total||0).toFixed(2);

    // Render table
    UI.rows.innerHTML = '';
    rows.forEach((r, idx)=>{
      UI.rows.appendChild(renderRow(r, idx, rows));
    });

    UI.table.style.display='block'; UI.stats.style.display='grid';
    recomputeStats();

    // Editable header fields
    UI.supplierInp.onchange = e=> updateHdr('supplier', e.target.value);
    UI.dateInp.onchange = e=> updateHdr('invoice_date', e.target.value);
    UI.totalInp.onchange = e=> { updateHdr('invoice_total', e.target.value); recomputeStats(); };

    // Rebuild tabindex for body cells after render
    rebuildTabOrder();
  }

  function renderRow(row, idx){
    const tr = document.createElement('tr');

    function tdInput(val, key, readOnly=false){
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.value = val==null? '': String(val);
      if(readOnly){ inp.className='readonly'; inp.readOnly=true; }
      inp.dataset.row = String(idx);
      inp.dataset.key = key;
      inp.onchange = ()=> updateCell(idx, key, inp.value);
      inp.onkeydown = (ev)=> handleCellKeydown(ev);
      td.appendChild(inp); return td;
    }

    const actions = document.createElement('td'); actions.className='actions';
    const add = document.createElement('button'); add.className='btn add'; add.textContent='‚ûï Below'; add.onclick=()=> addBelow(idx);
    const del = document.createElement('button'); del.className='btn del'; del.textContent='üóëÔ∏è'; del.onclick=()=> removeRow(idx);
    actions.appendChild(add); actions.appendChild(del);

    tr.appendChild(tdInput(row.position,'position'));
    tr.appendChild(tdInput(row.part_number,'part_number'));
    tr.appendChild(tdInput(row.quantity,'quantity'));
    tr.appendChild(tdInput(row.unit,'unit'));
    tr.appendChild(tdInput(row.unit_price,'unit_price'));
    tr.appendChild(tdInput(row.line_total,'line_total'));
    tr.appendChild(tdInput(row.net_weight,'net_weight'));
    tr.appendChild(tdInput(row.country_of_origin,'country_of_origin'));
    tr.appendChild(actions);

    return tr;
  }

  function updateCell(viewIdx, key, val){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){ ALL[idx][key]=val; renderInvoice(CURRENT); }
  }

  function addBelow(viewIdx){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const base = rows[viewIdx];
    const insert = { invoice_number: CURRENT, invoice_date: base.invoice_date, supplier: base.supplier, invoice_total: base.invoice_total, position: nextLetterPos(base.position), part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:'', country_of_origin: base.country_of_origin };
    const idx = ALL.indexOf(base);
    ALL.splice(idx+1, 0, insert);
    renderInvoice(CURRENT);
  }

  function removeRow(viewIdx){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT).slice();
    rows.sort((a,b)=>{
      const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
      const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
      if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
    });
    const target = rows[viewIdx];
    const idx = ALL.indexOf(target);
    if(idx>=0){ ALL.splice(idx,1); renderInvoice(CURRENT); }
  }

  function updateHdr(field, val){ ALL.forEach(r=>{ if(r.invoice_number===CURRENT){ r[field]=val; }}); }

  function recomputeStats(){
    const rows = ALL.filter(r=>r.invoice_number===CURRENT);
    const invTotal = parseNum(rows[0]?.invoice_total);
    const sum = sumLines(rows);
    UI.stTotal.textContent = '$'+(isFinite(invTotal)?invTotal.toFixed(2):'0.00');
    UI.stSum.textContent = '$'+sum.toFixed(2);
    const diff = (isFinite(invTotal)?invTotal:0) - sum;
    UI.stDiff.textContent = '$'+diff.toFixed(2);
  }

  // ---- Keyboard nav ----
  function rebuildTabOrder(){
    let ti = 10; // after header controls
    $$('#rows input').forEach(inp=>{ inp.tabIndex = ti++; });
  }
  function focusNext(current, dir){
    const inputs = [UI.invSel, UI.supplierInp, UI.dateInp, UI.totalInp, ...$$('#rows input')].filter(Boolean);
    const idx = inputs.indexOf(current);
    const nextIdx = Math.max(0, Math.min(inputs.length-1, idx + (dir||1)));
    const target = inputs[nextIdx];
    if(target){ target.focus(); target.select?.(); }
  }
  function handleCellKeydown(ev){
    if(ev.key === 'Enter'){
      ev.preventDefault();
      focusNext(ev.target, ev.shiftKey ? -1 : 1);
    }
  }

  // ---- Export ----
  function exportExcel(){
    const wb = XLSX.utils.book_new();
    const byInv = {};
    ALL.forEach(r=>{ if(!byInv[r.invoice_number]) byInv[r.invoice_number] = []; byInv[r.invoice_number].push(r); });
    Object.keys(byInv).forEach(id=>{
      const rows = byInv[id].slice().sort((a,b)=>{
        const A=(String(a.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
        const B=(String(b.position||'').match(/^(\d+)([A-Z]?)$/)||[]);
        const an=parseInt(A[1]||999999,10), bn=parseInt(B[1]||999999,10);
        if(an!==bn) return an-bn; return (A[2]||'').localeCompare(B[2]||'');
      });
      const head = [
        ['Invoice', id],
        ['Date', rows[0]?.invoice_date||''],
        ['Supplier', rows[0]?.supplier||''],
        ['Invoice Total', rows[0]?.invoice_total||''],
        [],
        ['Pos','Part Number','Quantity','Unit','Unit Price','Line Total','Net Weight (kg)','COO']
      ];
      const body = rows.map(r=>[
        r.position||'', r.part_number||'', r.quantity||'', r.unit||'', r.unit_price||'', r.line_total||'', r.net_weight||'', r.country_of_origin||''
      ]);
      const ws = XLSX.utils.aoa_to_sheet([...head, ...body]);
      XLSX.utils.book_append_sheet(wb, ws, ('INV_'+id).slice(0,31));
    });
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (filename? filename + '_' : '') + 'grass_parsed.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
